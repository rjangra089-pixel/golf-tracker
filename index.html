<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Golf Tracker Pro â€” Hoebridge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --green: #2d6a4f;
            --green-bright: #52b788;
            --green-light: #95d5b2;
            --fairway: #1b4332;
            --rough: #081c15;
            --dark: #060f0a;
            --card: #0e2318;
            --card2: #162d20;
            --sand: #e9c46a;
            --water: #0096c7;
            --red: #e63946;
            --orange: #f4a261;
            --white: #f0f4f1;
            --gray: #8fa898;
            --border: rgba(82,183,136,0.12);
            --border2: rgba(82,183,136,0.25);
            --font-display: 'Bebas Neue', sans-serif;
            --font-body: 'DM Sans', sans-serif;
            --font-mono: 'DM Mono', monospace;
        }

        html, body { height: 100%; background: var(--dark); overflow: hidden; }

        body {
            font-family: var(--font-body);
            color: var(--white);
            display: flex;
            flex-direction: column;
            height: 100dvh;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SCREENS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .screen { display: none; flex-direction: column; height: 100dvh; overflow: hidden; animation: fadeIn 0.3s ease; }
        .screen.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BOTTOM NAV (shared)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .bottom-nav {
            display: flex;
            background: var(--fairway);
            border-top: 1px solid var(--border2);
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bnav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 10px 0;
            background: none;
            border: none;
            color: var(--gray);
            font-family: var(--font-body);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: color 0.15s;
        }

        .bnav-btn.active { color: var(--green-bright); }
        .bnav-btn svg { width: 20px; height: 20px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LANDING / CLUBHOUSE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #screen-home {
            background: radial-gradient(ellipse at 20% 0%, #1b4332 0%, var(--dark) 55%);
        }

        .home-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .home-hero {
            padding: 36px 20px 24px;
            position: relative;
        }

        .home-greeting {
            font-size: 13px;
            color: var(--green-light);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 6px;
        }

        .home-name {
            font-family: var(--font-display);
            font-size: 52px;
            color: var(--white);
            line-height: 1;
            letter-spacing: 1px;
        }

        .home-course {
            font-size: 13px;
            color: var(--gray);
            margin-top: 6px;
        }

        .home-course span { color: var(--green-bright); }

        /* HC Progress */
        .hc-track {
            margin: 24px 20px;
            background: var(--card);
            border: 1px solid var(--border2);
            border-radius: 20px;
            padding: 20px;
        }

        .hc-track-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .hc-current {
            font-family: var(--font-display);
            font-size: 56px;
            color: var(--green-bright);
            line-height: 1;
        }

        .hc-label { font-size: 13px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; }

        .hc-target-block { text-align: right; }
        .hc-target { font-family: var(--font-display); font-size: 32px; color: var(--sand); }

        .hc-bar-track {
            height: 8px;
            background: var(--card2);
            border-radius: 99px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .hc-bar-fill {
            height: 100%;
            border-radius: 99px;
            background: linear-gradient(90deg, var(--green), var(--green-bright), var(--sand));
            transition: width 1s cubic-bezier(.4,0,.2,1);
        }

        .hc-bar-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--gray);
        }

        /* Quick stats row */
        .stats-strip {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 0 20px 20px;
        }

        .stat-chip {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
        }

        .stat-chip-val {
            font-family: var(--font-display);
            font-size: 30px;
            color: var(--white);
            line-height: 1;
        }

        .stat-chip-lbl {
            font-size: 13px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 3px;
        }

        /* Recent rounds */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            margin-bottom: 12px;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 22px;
            color: var(--white);
            letter-spacing: 0.5px;
        }

        .section-link {
            font-size: 12px;
            color: var(--green-bright);
            background: none;
            border: none;
            cursor: pointer;
            font-family: var(--font-body);
        }

        .rounds-list {
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 24px;
        }

        .round-row {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .round-row-date {
            flex: 1;
        }

        .round-row-date-main { font-size: 14px; font-weight: 500; }
        .round-row-date-sub { font-size: 13px; color: var(--gray); margin-top: 2px; }

        .round-row-score {
            font-family: var(--font-display);
            font-size: 28px;
            color: var(--white);
        }

        .round-row-pts {
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            min-width: 48px;
            text-align: center;
        }

        .trend-arrow { font-size: 16px; }

        /* Play button */
        .play-cta {
            margin: 0 20px 24px;
            background: var(--green-bright);
            color: var(--rough);
            border: none;
            border-radius: 16px;
            font-family: var(--font-display);
            font-size: 26px;
            letter-spacing: 1px;
            padding: 18px;
            width: calc(100% - 40px);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .play-cta:active { transform: scale(0.97); }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state-title { font-family: var(--font-display); font-size: 24px; color: var(--white); margin-bottom: 8px; }
        .empty-state-text { font-size: 13px; line-height: 1.6; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           STATS SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #screen-stats {
            background: var(--dark);
        }

        .stats-topbar {
            background: var(--fairway);
            border-bottom: 1px solid var(--border2);
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .stats-topbar-title {
            font-family: var(--font-display);
            font-size: 28px;
            color: var(--green-bright);
            letter-spacing: 0.5px;
        }

        .stats-topbar-sub { font-size: 14px; color: var(--gray); margin-top: 2px; }

        .stats-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Chart card */
        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 18px;
        }

        .chart-title {
            font-family: var(--font-display);
            font-size: 20px;
            color: var(--white);
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .chart-sub { font-size: 11px; color: var(--gray); margin-bottom: 16px; }

        .chart-wrap { position: relative; height: 180px; }

        /* Hole breakdown table */
        .hole-table {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            overflow: hidden;
        }

        .hole-table-header {
            padding: 16px 18px 12px;
            border-bottom: 1px solid var(--border);
        }

        .hole-table-title {
            font-family: var(--font-display);
            font-size: 20px;
            color: var(--white);
        }

        .hole-table-sub { font-size: 13px; color: var(--gray); margin-top: 3px; }

        .ht-row {
            display: grid;
            grid-template-columns: 32px 42px 50px 50px 50px 1fr;
            gap: 4px;
            padding: 10px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            align-items: center;
        }

        .ht-row.header-row {
            background: var(--card2);
            padding: 8px 14px;
        }

        .ht-col {
            font-size: 11px;
            color: var(--gray);
            text-align: center;
        }

        .ht-col.left { text-align: left; }

        .ht-row.header-row .ht-col {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .ht-num { font-family: var(--font-display); font-size: 18px; color: var(--gray); }
        .ht-par { font-size: 13px; color: var(--gray); text-align: center; }

        .ht-avg {
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            padding: 3px 6px;
            border-radius: 6px;
        }

        .ht-target { font-family: var(--font-mono); font-size: 13px; color: var(--green-light); text-align: center; }
        .ht-gir { font-size: 13px; text-align: center; color: var(--gray); }

        .ht-advice {
            font-size: 13px;
            color: var(--gray);
            line-height: 1.4;
            padding-left: 4px;
        }

        .ht-advice .tag {
            display: inline-block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        /* Rating colors */
        .rating-eagle  { background: rgba(246,216,96,0.2);  color: #f6d860; }
        .rating-birdie { background: rgba(82,183,136,0.2);  color: var(--green-bright); }
        .rating-par    { background: rgba(116,179,206,0.2); color: #74b3ce; }
        .rating-bogey  { background: rgba(244,162,97,0.2);  color: var(--orange); }
        .rating-double { background: rgba(230,57,70,0.15);  color: var(--red); }
        .rating-worse  { background: rgba(180,0,0,0.15);    color: #ff6b6b; }

        .tag-strength  { background: rgba(82,183,136,0.2);  color: var(--green-bright); }
        .tag-problem   { background: rgba(230,57,70,0.15);  color: var(--red); }
        .tag-average   { background: rgba(244,162,97,0.15); color: var(--orange); }

        /* Summary stats grid */
        .sum-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .sum-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
        }

        .sum-card-val {
            font-family: var(--font-display);
            font-size: 36px;
            color: var(--green-bright);
            line-height: 1;
        }

        .sum-card-lbl { font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

        /* Round history */
        .round-history-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rhi-left { flex: 1; }
        .rhi-date { font-size: 14px; font-weight: 500; }
        .rhi-sub { font-size: 13px; color: var(--gray); margin-top: 2px; }
        .rhi-score { font-family: var(--font-display); font-size: 32px; color: var(--white); }
        .rhi-pts { font-family: var(--font-mono); font-size: 13px; padding: 4px 10px; border-radius: 20px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SETUP SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #screen-setup {
            background: radial-gradient(ellipse at 50% 0%, #1b4332 0%, var(--dark) 60%);
            align-items: center;
            justify-content: center;
            padding: 30px 24px;
            gap: 0;
            overflow-y: auto;
        }

        .setup-logo {
            font-family: var(--font-display);
            font-size: 48px;
            color: var(--green-bright);
            letter-spacing: 2px;
            text-align: center;
        }

        .setup-course-tag {
            font-size: 12px;
            color: var(--green-light);
            text-transform: uppercase;
            letter-spacing: 3px;
            text-align: center;
            margin-top: 4px;
            margin-bottom: 32px;
        }

        .setup-card {
            width: 100%;
            max-width: 380px;
            background: var(--card);
            border: 1px solid var(--border2);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .field-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--green-light);
            margin-bottom: 7px;
        }

        .field-input {
            width: 100%;
            background: var(--rough);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            color: var(--white);
            font-family: var(--font-body);
            font-size: 16px;
            padding: 13px 16px;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }

        .field-input:focus { border-color: var(--green-bright); }

        .hc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .btn-teeoff {
            width: 100%;
            background: var(--green-bright);
            color: var(--rough);
            border: none;
            border-radius: 12px;
            font-family: var(--font-display);
            font-size: 24px;
            letter-spacing: 1px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-teeoff:active { transform: scale(0.97); }

        .btn-back-setup {
            width: 100%;
            background: transparent;
            color: var(--gray);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 14px;
            padding: 12px;
            cursor: pointer;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PLAY SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #screen-play { background: var(--dark); }

        .topbar {
            background: var(--fairway);
            border-bottom: 2px solid var(--green);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .topbar-hole { font-family: var(--font-display); font-size: 36px; color: var(--green-bright); line-height: 1; }
        .topbar-meta { font-size: 13px; color: var(--gray); }
        .topbar-meta span { color: var(--green-light); font-weight: 600; }
        .topbar-pts-val { font-family: var(--font-display); font-size: 36px; color: var(--sand); line-height: 1; text-align: right; }
        .topbar-pts-lbl { font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; text-align: right; }

        .progress-bar { height: 3px; background: var(--card); flex-shrink: 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--green), var(--green-bright)); transition: width 0.4s ease; }

        .play-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .hole-info-card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .hole-info-card.danger { border-color: rgba(230,57,70,0.4); }

        .hole-info-header {
            padding: 14px 18px;
            background: var(--card2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .hole-title-group { display: flex; align-items: baseline; gap: 10px; }
        .hole-big-num { font-family: var(--font-display); font-size: 44px; color: var(--white); line-height: 1; }

        .par-tag {
            font-family: var(--font-mono);
            font-size: 11px;
            background: var(--green);
            color: var(--green-light);
            padding: 3px 8px;
            border-radius: 20px;
        }

        .si-tag { font-family: var(--font-mono); font-size: 13px; color: var(--gray); }
        .danger-tag { font-size: 13px; font-weight: 600; color: var(--red); background: rgba(230,57,70,0.12); border: 1px solid rgba(230,57,70,0.3); padding: 3px 10px; border-radius: 20px; }
        .hole-yardage { font-family: var(--font-mono); font-size: 13px; color: var(--gray); text-align: right; }
        .hole-yardage strong { color: var(--white); font-size: 18px; display: block; }

        /* My average for this hole */
        .my-avg-bar {
            padding: 10px 18px;
            background: rgba(82,183,136,0.05);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--gray);
        }

        .my-avg-val { font-family: var(--font-mono); font-size: 13px; font-weight: 500; }

        .caddie-tip {
            padding: 12px 18px;
            font-size: 15px;
            color: var(--green-light);
            line-height: 1.6;
            border-top: 1px solid var(--border);
            font-style: italic;
            font-weight: 500;
        }

        .scoring-card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .score-section { padding: 16px 18px; }
        .section-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; color: var(--gray); margin-bottom: 12px; }

        .score-buttons { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 2px; }
        .score-buttons::-webkit-scrollbar { display: none; }

        .score-btn-wrap { display: flex; flex-direction: column; align-items: center; gap: 0; padding-bottom: 20px; flex-shrink: 0; }

        .score-btn {
            width: 54px; height: 54px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--card2);
            color: var(--gray);
            font-family: var(--font-display);
            font-size: 26px;
            cursor: pointer;
            transition: all 0.12s;
            display: flex; align-items: center; justify-content: center;
        }

        .score-label { font-family: var(--font-body); font-size: 11px; color: var(--gray); margin-top: 4px; white-space: nowrap; }

        .score-btn.eagle  { border-color: #f6d860; background: rgba(246,216,96,0.12); color: #f6d860; }
        .score-btn.birdie { border-color: var(--green-bright); background: rgba(82,183,136,0.12); color: var(--green-bright); }
        .score-btn.par    { border-color: #74b3ce; background: rgba(116,179,206,0.12); color: #74b3ce; }
        .score-btn.bogey  { border-color: var(--orange); background: rgba(244,162,97,0.12); color: var(--orange); }
        .score-btn.double { border-color: var(--red); background: rgba(230,57,70,0.1); color: var(--red); }
        .score-btn.triple, .score-btn.more { border-color: #555; background: rgba(100,100,100,0.1); color: #888; }

        .score-btn.selected { transform: scale(1.1); }
        .score-btn.eagle.selected  { box-shadow: 0 0 0 3px rgba(246,216,96,0.4); }
        .score-btn.birdie.selected { box-shadow: 0 0 0 3px rgba(82,183,136,0.4); }
        .score-btn.par.selected    { box-shadow: 0 0 0 3px rgba(116,179,206,0.4); }
        .score-btn.bogey.selected  { box-shadow: 0 0 0 3px rgba(244,162,97,0.4); }
        .score-btn.double.selected { box-shadow: 0 0 0 3px rgba(230,57,70,0.35); }

        .points-result { margin: 0 18px 14px; padding: 12px; border-radius: 12px; text-align: center; display: none; }
        .points-result.visible { display: block; }
        .points-result-val { font-family: var(--font-display); font-size: 40px; line-height: 1; }
        .points-result-name { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; margin-top: 3px; }

        .putts-section { border-top: 1px solid var(--border); padding: 14px 18px; }
        .putts-buttons { display: flex; gap: 10px; }

        .putt-btn {
            flex: 1; height: 46px;
            border-radius: 10px;
            border: 1.5px solid var(--border);
            background: var(--card2);
            color: var(--gray);
            font-family: var(--font-display);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.12s;
        }

        .putt-btn.selected { background: rgba(82,183,136,0.18); border-color: var(--green-bright); color: var(--green-bright); }

        .stats-row { border-top: 1px solid var(--border); padding: 14px 18px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .toggle-group { display: flex; gap: 6px; }

        .toggle-btn {
            flex: 1; height: 38px;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: var(--card2);
            color: var(--gray);
            font-family: var(--font-body);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.12s;
        }

        .toggle-btn.hit { background: rgba(82,183,136,0.18); border-color: var(--green-bright); color: var(--green-bright); }
        .toggle-btn.miss-l, .toggle-btn.miss-r { background: rgba(244,162,97,0.1); border-color: rgba(244,162,97,0.5); color: var(--orange); }
        .toggle-btn.ob { background: rgba(230,57,70,0.1); border-color: rgba(230,57,70,0.4); color: var(--red); }

        .nav-bar {
            display: flex; gap: 12px;
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            background: var(--fairway);
            border-top: 1px solid var(--border2);
            flex-shrink: 0;
        }

        .btn-nav { flex: 1; height: 50px; border-radius: 12px; border: none; font-family: var(--font-display); font-size: 18px; cursor: pointer; transition: all 0.12s; }
        .btn-prev { background: var(--card2); color: var(--gray); border: 1.5px solid var(--border); }
        .btn-next { background: var(--green-bright); color: var(--rough); flex: 2; }
        .btn-next:disabled { background: var(--card2); color: var(--gray); }
        .btn-next:active:not(:disabled) { transform: scale(0.97); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SUMMARY SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #screen-summary {
            background: radial-gradient(ellipse at 50% 0%, #1b4332 0%, var(--dark) 60%);
        }

        .summary-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        .summary-header {
            background: var(--fairway);
            border-bottom: 1px solid var(--border2);
            padding: 20px 20px 16px;
            text-align: center;
        }

        .summary-title { font-family: var(--font-display); font-size: 40px; color: var(--green-bright); letter-spacing: 1px; }
        .summary-date { font-size: 13px; color: var(--gray); margin-top: 4px; }

        .summary-hero {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hero-stat { background: var(--card); border-radius: 16px; border: 1px solid var(--border); padding: 16px; text-align: center; }
        .hero-stat.big { grid-column: 1 / -1; background: var(--card2); border-color: var(--border2); }
        .hero-val { font-family: var(--font-display); font-size: 48px; color: var(--green-bright); line-height: 1; }
        .hero-stat.big .hero-val { font-size: 64px; }
        .hero-lbl { font-size: 12px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

        .hole-summary-list { padding: 0 16px 16px; display: flex; flex-direction: column; gap: 6px; }

        .hole-summary-row {
            background: var(--card);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hs-num { font-family: var(--font-display); font-size: 20px; color: var(--gray); width: 26px; }
        .hs-par { font-size: 13px; color: var(--gray); width: 36px; }
        .hs-score { font-family: var(--font-display); font-size: 22px; color: var(--white); margin-left: auto; }
        .hs-pts { font-family: var(--font-mono); font-size: 13px; font-weight: 500; padding: 3px 10px; border-radius: 20px; min-width: 40px; text-align: center; }

        .summary-actions { padding: 16px; display: flex; flex-direction: column; gap: 10px; }

        .btn-save {
            width: 100%; height: 54px;
            border-radius: 14px; border: none;
            background: var(--green-bright); color: var(--rough);
            font-family: var(--font-display); font-size: 22px; letter-spacing: 1px;
            cursor: pointer; transition: all 0.15s;
        }

        .btn-save:active { transform: scale(0.97); }
        .btn-save:disabled { background: var(--card2); color: var(--gray); }
        .btn-new { width: 100%; height: 46px; border-radius: 12px; border: 1.5px solid var(--border); background: transparent; color: var(--gray); font-family: var(--font-body); font-size: 14px; font-weight: 500; cursor: pointer; }

        .save-status { text-align: center; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: 500; display: none; }
        .save-status.success { display: block; background: rgba(82,183,136,0.12); color: var(--green-bright); border: 1px solid rgba(82,183,136,0.3); }
        .save-status.error { display: block; background: rgba(230,57,70,0.1); color: var(--red); border: 1px solid rgba(230,57,70,0.3); }

        /* HC edit */
        .hc-target-edit {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: flex-end;
        }

        .hc-target-input {
            width: 64px;
            background: var(--rough);
            border: 1.5px solid var(--border2);
            border-radius: 8px;
            color: var(--sand);
            font-family: var(--font-display);
            font-size: 28px;
            padding: 2px 8px;
            text-align: center;
            outline: none;
            -webkit-appearance: none;
        }

        .hc-target-input:focus { border-color: var(--sand); }

        .hc-save-btn {
            font-size: 11px;
            font-weight: 600;
            color: var(--green-bright);
            background: rgba(82,183,136,0.15);
            border: 1px solid var(--border2);
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            display: none;
        }

        /* Delete round */
        .rhi-delete {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .rhi-delete:hover { color: var(--red); background: rgba(230,57,70,0.1); }

        .delete-confirm {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .delete-confirm-box {
            background: var(--card2);
            border: 1px solid var(--border2);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .delete-confirm-title {
            font-family: var(--font-display);
            font-size: 24px;
            color: var(--red);
            margin-bottom: 8px;
        }

        .delete-confirm-sub { font-size: 13px; color: var(--gray); margin-bottom: 20px; }

        .delete-confirm-btns { display: flex; gap: 10px; }

        .delete-cancel {
            flex: 1; height: 48px; border-radius: 12px;
            background: var(--card); border: 1.5px solid var(--border);
            color: var(--gray); font-family: var(--font-body); font-size: 14px;
            font-weight: 500; cursor: pointer;
        }

        .delete-go {
            flex: 1; height: 48px; border-radius: 12px;
            background: var(--red); border: none;
            color: #fff; font-family: var(--font-display); font-size: 20px;
            cursor: pointer;
        }


        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LIVE CADDIE MODE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* Pace tracker in topbar */
        .topbar-pace {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 20px;
            text-align: center;
            margin-top: 4px;
            letter-spacing: 0.5px;
        }
        .pace-ahead  { background: rgba(82,183,136,0.2);  color: var(--green-bright); }
        .pace-behind { background: rgba(244,162,97,0.2);  color: var(--orange); }
        .pace-on     { background: rgba(116,179,206,0.2); color: #74b3ce; }

        /* Caddie briefing panel */
        .caddie-briefing {
            background: linear-gradient(135deg, #0d2b1d 0%, #0e2318 100%);
            border: 1px solid var(--border2);
            border-radius: 16px;
            margin: 0 0 12px 0;
            overflow: hidden;
        }

        .caddie-briefing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }

        .caddie-briefing-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--green-bright);
        }

        .caddie-briefing-chevron {
            font-size: 12px;
            color: var(--gray);
            transition: transform 0.2s;
        }

        .caddie-briefing.collapsed .caddie-briefing-chevron { transform: rotate(-90deg); }

        .caddie-briefing-body {
            padding: 0 16px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .caddie-briefing.collapsed .caddie-briefing-body { display: none; }

        /* Stats grid inside briefing */
        .caddie-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .caddie-stat {
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 8px;
            text-align: center;
        }

        .caddie-stat-val {
            font-family: var(--font-display);
            font-size: 26px;
            line-height: 1;
            color: var(--white);
        }

        .caddie-stat-lbl {
            font-size: 10px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 4px;
        }

        /* Strategy block */
        .caddie-strategy {
            background: rgba(82,183,136,0.06);
            border-left: 3px solid var(--green-bright);
            border-radius: 0 10px 10px 0;
            padding: 10px 14px;
            font-size: 14px;
            color: var(--green-light);
            line-height: 1.5;
            font-style: italic;
        }

        /* Post-hole feedback banner */
        .hole-feedback {
            margin: 0 0 12px 0;
            padding: 14px 16px;
            border-radius: 14px;
            display: none;
            animation: feedbackIn 0.3s cubic-bezier(.34,1.56,.64,1);
        }

        @keyframes feedbackIn {
            from { opacity: 0; transform: scale(0.95) translateY(-4px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .hole-feedback.visible { display: block; }

        .feedback-pts {
            font-family: var(--font-display);
            font-size: 42px;
            line-height: 1;
            margin-bottom: 4px;
        }

        .feedback-label {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .feedback-vs {
            font-size: 13px;
            opacity: 0.85;
            line-height: 1.4;
        }

        .feedback-msg {
            font-size: 13px;
            margin-top: 8px;
            font-style: italic;
            opacity: 0.8;
            line-height: 1.4;
        }

        /* Momentum badge */
        .momentum-badge {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 12px;
            margin: 0 0 12px 0;
            font-size: 13px;
            font-weight: 600;
            animation: feedbackIn 0.4s cubic-bezier(.34,1.56,.64,1);
        }

        .momentum-badge.visible { display: flex; }
        .momentum-badge.hot  { background: rgba(246,216,96,0.12); border: 1px solid rgba(246,216,96,0.3); color: #f6d860; }
        .momentum-badge.cold { background: rgba(230,57,70,0.10);  border: 1px solid rgba(230,57,70,0.25);  color: var(--red); }
        .momentum-badge.good { background: rgba(82,183,136,0.10); border: 1px solid rgba(82,183,136,0.25); color: var(--green-bright); }

        .momentum-icon { font-size: 20px; }

        /* Milestone banner */
        .milestone-banner {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            border-radius: 16px;
            margin: 0 0 12px 0;
            text-align: center;
            background: linear-gradient(135deg, rgba(82,183,136,0.15), rgba(233,196,106,0.1));
            border: 1px solid var(--border2);
            animation: feedbackIn 0.4s cubic-bezier(.34,1.56,.64,1);
        }

        .milestone-banner.visible { display: flex; }
        .milestone-icon { font-size: 32px; margin-bottom: 6px; }
        .milestone-title { font-family: var(--font-display); font-size: 22px; color: var(--green-bright); }
        .milestone-sub { font-size: 13px; color: var(--gray); margin-top: 4px; line-height: 1.4; }

        /* Loading */
        .loading-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--gray);
            font-size: 13px;
            gap: 10px;
        }

        .spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--green-bright);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: HOME / CLUBHOUSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-home" class="screen active">
    <div class="home-scroll">
        <div class="home-hero">
            <div class="home-greeting">Welcome back</div>
            <div class="home-name" id="home-name">Rajiv</div>
            <div class="home-course">Hoebridge Golf Centre Â· <span>Par 72</span></div>
        </div>

        <!-- HC Progress -->
        <div class="hc-track">
            <div class="hc-track-header">
                <div>
                    <div class="hc-target-edit">
                        <input class="hc-target-input" id="home-hc" type="number" min="0" max="54" step="0.1" value="27.0"
                            style="color:var(--green-bright);width:80px;font-size:44px"
                            oninput="onCurrentHCChange()" onblur="saveCurrentHC()">
                        <button class="hc-save-btn" id="hc-current-save-btn" onclick="saveCurrentHC()">Save</button>
                    </div>
                    <div class="hc-label" style="margin-top:4px">Current HC</div>
                </div>
                <div class="hc-target-block">
                    <div class="hc-target-edit">
                        <input class="hc-target-input" id="home-target-hc" type="number" min="0" max="54" value="16"
                            oninput="onTargetHCChange()" onblur="saveTargetHC()">
                        <button class="hc-save-btn" id="hc-save-btn" onclick="saveTargetHC()">Save</button>
                    </div>
                    <div class="hc-label" style="text-align:right;margin-top:4px">Target HC</div>
                </div>
            </div>
            <div class="hc-bar-track">
                <div class="hc-bar-fill" id="home-hc-bar" style="width:0%"></div>
            </div>
            <div class="hc-bar-labels">
                <span id="home-hc-bar-lbl">Loading...</span>
                <span id="home-rounds-played">â€” rounds</span>
            </div>
        </div>

        <!-- Quick stats -->
        <div class="stats-strip">
            <div class="stat-chip">
                <div class="stat-chip-val" id="home-avg-pts">â€”</div>
                <div class="stat-chip-lbl">Avg Pts</div>
            </div>
            <div class="stat-chip">
                <div class="stat-chip-val" id="home-avg-score">â€”</div>
                <div class="stat-chip-lbl">Avg Score</div>
            </div>
            <div class="stat-chip">
                <div class="stat-chip-val" id="home-best-pts">â€”</div>
                <div class="stat-chip-lbl">Best Pts</div>
            </div>
        </div>

        <!-- Recent rounds -->
        <div class="section-header">
            <div class="section-title">Recent Rounds</div>
            <button class="section-link" onclick="showScreen('screen-stats')">See all â†’</button>
        </div>

        <div id="home-rounds-list" class="rounds-list">
            <div class="loading-overlay"><div class="spinner"></div> Loading rounds...</div>
        </div>

        <!-- Play CTA -->
        <button class="play-cta" onclick="showScreen('screen-setup')">
            â›³ Play a Round
        </button>
    </div>

    <div class="bottom-nav">
        <button class="bnav-btn active" onclick="showScreen('screen-home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
            Home
        </button>
        <button class="bnav-btn" onclick="showScreen('screen-stats')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            Stats
        </button>
        <button class="bnav-btn" onclick="showScreen('screen-setup')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            Play
        </button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: STATS DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-stats" class="screen">
    <div class="stats-topbar">
        <div class="stats-topbar-title">MY GAME</div>
        <div class="stats-topbar-sub" id="stats-sub">Last 20 rounds Â· Hoebridge</div>
    </div>

    <div class="stats-scroll" id="stats-scroll">
        <div class="loading-overlay"><div class="spinner"></div> Loading your stats...</div>
    </div>

    <div class="bottom-nav">
        <button class="bnav-btn" onclick="showScreen('screen-home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
            Home
        </button>
        <button class="bnav-btn active" onclick="showScreen('screen-stats')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            Stats
        </button>
        <button class="bnav-btn" onclick="showScreen('screen-setup')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            Play
        </button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: SETUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-setup" class="screen">
    <div style="flex:1; overflow-y:auto; display:flex; align-items:center; justify-content:center; padding:30px 24px;">
        <div style="width:100%; max-width:380px; display:flex; flex-direction:column; gap:0; align-items:center;">
            <div class="setup-logo">TEE OFF</div>
            <div class="setup-course-tag">Hoebridge Â· Par 72</div>

            <div class="setup-card">
                <div>
                    <div class="field-label">Your Name</div>
                    <input class="field-input" id="setup-name" type="text" placeholder="Rajiv" value="Rajiv" autocomplete="off">
                </div>
                <div class="hc-grid">
                    <div>
                        <div class="field-label">Playing HC</div>
                        <input class="field-input" id="setup-hc" type="number" placeholder="27" value="27" min="0" max="54">
                    </div>
                    <div>
                        <div class="field-label">Date</div>
                        <input class="field-input" id="setup-date" type="date">
                    </div>
                </div>
                <button class="btn-teeoff" onclick="startRound()">TEE OFF â†’</button>
                <button class="btn-back-setup" onclick="showScreen('screen-home')">â† Back to Clubhouse</button>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: PLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-play" class="screen">
    <div class="topbar">
        <div>
            <div class="topbar-hole" id="tb-hole">HOLE 1</div>
            <div class="topbar-meta">Par <span id="tb-par">5</span> Â· SI <span id="tb-si">11</span> Â· <span id="tb-yards">404</span>y</div>
        </div>
        <div style="text-align:right">
            <div class="topbar-pts-val" id="tb-pts">0</div>
            <div class="topbar-pts-lbl">Points</div>
            <div class="topbar-pace" id="tb-pace" style="display:none"></div>
        </div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>

    <div class="play-scroll" id="play-scroll">

        <!-- Momentum badge -->
        <div class="momentum-badge" id="momentum-badge">
            <span class="momentum-icon" id="momentum-icon">ğŸ”¥</span>
            <span id="momentum-text">On a roll!</span>
        </div>

        <!-- Milestone banner -->
        <div class="milestone-banner" id="milestone-banner">
            <div class="milestone-icon" id="milestone-icon">ğŸ</div>
            <div class="milestone-title" id="milestone-title">Halfway!</div>
            <div class="milestone-sub" id="milestone-sub"></div>
        </div>

        <!-- Post-hole feedback (shown after score entered + Next tapped) -->
        <div class="hole-feedback" id="hole-feedback">
            <div class="feedback-pts" id="feedback-pts">2</div>
            <div class="feedback-label" id="feedback-label">Par</div>
            <div class="feedback-vs" id="feedback-vs"></div>
            <div class="feedback-msg" id="feedback-msg"></div>
        </div>

        <!-- Caddie briefing panel -->
        <div class="caddie-briefing" id="caddie-briefing">
            <div class="caddie-briefing-header" onclick="toggleBriefing()">
                <div class="caddie-briefing-title">ğŸŒï¸ Caddie Briefing â€” Hole <span id="cb-hole-num">1</span></div>
                <div class="caddie-briefing-chevron" id="cb-chevron">â–¼</div>
            </div>
            <div class="caddie-briefing-body">
                <div class="caddie-stats-grid">
                    <div class="caddie-stat">
                        <div class="caddie-stat-val" id="cb-avg">â€”</div>
                        <div class="caddie-stat-lbl">Your Avg</div>
                    </div>
                    <div class="caddie-stat">
                        <div class="caddie-stat-val" id="cb-target">â€”</div>
                        <div class="caddie-stat-lbl">Target</div>
                    </div>
                    <div class="caddie-stat">
                        <div class="caddie-stat-val" id="cb-shots">â€”</div>
                        <div class="caddie-stat-lbl">Shots HC</div>
                    </div>
                </div>
                <div class="caddie-stats-grid">
                    <div class="caddie-stat">
                        <div class="caddie-stat-val" id="cb-gir" style="font-size:18px">â€”</div>
                        <div class="caddie-stat-lbl">GIR %</div>
                    </div>
                    <div class="caddie-stat">
                        <div class="caddie-stat-val" id="cb-putts">â€”</div>
                        <div class="caddie-stat-lbl">Avg Putts</div>
                    </div>
                    <div class="caddie-stat">
                        <div class="caddie-stat-val" id="cb-rounds" style="font-size:18px">â€”</div>
                        <div class="caddie-stat-lbl">Rounds</div>
                    </div>
                </div>
                <div class="caddie-strategy" id="cb-strategy">Loading strategy...</div>
                <div id="cb-danger-block" style="display:none;background:rgba(230,57,70,0.08);border:1px solid rgba(230,57,70,0.25);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--red);line-height:1.5">
                    âš ï¸ <strong>Danger hole.</strong> <span id="cb-danger-text"></span>
                </div>
            </div>
        </div>

        <!-- Hole header (compact, always visible) -->
        <div class="hole-info-card" id="hole-info-card">
            <div class="hole-info-header" id="hole-info-header">
                <div class="hole-title-group">
                    <div class="hole-big-num" id="hi-num">1</div>
                    <div>
                        <div class="par-tag" id="hi-par">Par 5</div>
                        <div class="si-tag" id="hi-si">SI 11</div>
                    </div>
                </div>
                <div>
                    <div id="hi-danger" class="danger-tag" style="display:none">âš  DANGER</div>
                    <div class="hole-yardage"><strong id="hi-yards">404</strong>yards</div>
                </div>
            </div>
        </div>

        <div class="scoring-card">
            <div class="score-section">
                <div class="section-label">Score</div>
                <div class="score-buttons" id="score-buttons"></div>
            </div>
            <div class="points-result" id="points-result">
                <div class="points-result-val" id="pr-val">2</div>
                <div class="points-result-name" id="pr-name">Par</div>
            </div>
            <div class="putts-section">
                <div class="section-label">Putts</div>
                <div class="putts-buttons">
                    <button class="putt-btn" data-putts="1" onclick="selectPutts(1)">1</button>
                    <button class="putt-btn" data-putts="2" onclick="selectPutts(2)">2</button>
                    <button class="putt-btn" data-putts="3" onclick="selectPutts(3)">3</button>
                    <button class="putt-btn" data-putts="4" onclick="selectPutts(4)">4</button>
                </div>
            </div>
            <div class="stats-row">
                <div id="fairway-group">
                    <div class="section-label">Fairway</div>
                    <div class="toggle-group">
                        <button class="toggle-btn" onclick="selectFairway('C')">âœ“</button>
                        <button class="toggle-btn" onclick="selectFairway('L')">â—€</button>
                        <button class="toggle-btn" onclick="selectFairway('R')">â–¶</button>
                        <button class="toggle-btn" onclick="selectFairway('X')">OB</button>
                    </div>
                </div>
                <div>
                    <div class="section-label">GIR</div>
                    <div class="toggle-group">
                        <button class="toggle-btn" onclick="selectGIR(true)">Yes</button>
                        <button class="toggle-btn" onclick="selectGIR(false)">No</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="btn-nav btn-prev" id="btn-prev" onclick="prevHole()">â† Back</button>
        <button class="btn-nav btn-next" id="btn-next" onclick="nextHole()">Next Hole â†’</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-summary" class="screen">
    <div class="summary-scroll">
        <div class="summary-header">
            <div class="summary-title">ROUND COMPLETE</div>
            <div class="summary-date" id="sum-date"></div>
            <div class="summary-date" id="sum-name"></div>
        </div>
        <div class="summary-hero">
            <div class="hero-stat big">
                <div class="hero-val" id="sum-pts">0</div>
                <div class="hero-lbl">Stableford Points</div>
            </div>
            <div class="hero-stat"><div class="hero-val" id="sum-score">0</div><div class="hero-lbl">Gross Score</div></div>
            <div class="hero-stat"><div class="hero-val" id="sum-putts">0</div><div class="hero-lbl">Total Putts</div></div>
            <div class="hero-stat"><div class="hero-val" id="sum-girs">0</div><div class="hero-lbl">GIR</div></div>
            <div class="hero-stat"><div class="hero-val" id="sum-firs">0</div><div class="hero-lbl">Fairways</div></div>
        </div>
        <div class="hole-summary-list" id="hole-summary-list"></div>
        <div class="summary-actions">
            <div class="save-status" id="save-status"></div>
            <button class="btn-save" id="btn-save" onclick="saveRound()">SAVE ROUND</button>
            <button class="btn-new" onclick="goHome()">â† Back to Clubhouse</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://fnnxleatonxijyfghpts.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZubnhsZWF0b254aWp5ZmdocHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDQ2NzMsImV4cCI6MjA4NzYyMDY3M30.83t4SPEJ3okFR9M04O4T96-55ybS0__cI3TKP9v034k';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOLES DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HOLES = [
    { num:1,  par:5, si:11, yards:404, danger:false, tip:"Start strong. Fairway over distance. Uphill approach â€” club up." },
    { num:2,  par:3, si:17, yards:167, danger:false, tip:"Elevated tee. Centre green mentality â€” take what it gives you." },
    { num:3,  par:5, si:7,  yards:505, danger:true,  tip:"Slopes! Stay left of fairway. Sharp drop on left â€” stay safe." },
    { num:4,  par:4, si:1,  yards:389, danger:true,  tip:"HARDEST HOLE. Tight driving corridor. Aim left-centre. Accept bogey." },
    { num:5,  par:4, si:3,  yards:333, danger:true,  tip:"Danger zone. Fairway is everything. Aim 30y short of the green." },
    { num:6,  par:3, si:15, yards:162, danger:false, tip:"Mid-length par 3. Club selection is crucial â€” trust your yardage." },
    { num:7,  par:4, si:5,  yards:458, danger:true,  tip:"Long and tough. Find the fairway first. Accept bogey as a win." },
    { num:8,  par:4, si:9,  yards:364, danger:true,  tip:"Elevated green. Remember to club up on your approach shot." },
    { num:9,  par:5, si:13, yards:505, danger:false, tip:"Finish the front 9 strong. Lay up short, then wedge it in close." },
    { num:10, par:4, si:12, yards:315, danger:false, tip:"YOUR BEST PAR 4! Keep doing exactly what works here." },
    { num:11, par:4, si:4,  yards:364, danger:true,  tip:"Problem hole. Fairway â†’ Aim short â†’ Chip â†’ 2 putts. Keep it simple." },
    { num:12, par:3, si:18, yards:180, danger:false, tip:"SUPERSTAR HOLE! You've got this figured out. Trust your instincts." },
    { num:13, par:5, si:8,  yards:514, danger:true,  tip:"Lay up strategy here. Two solid shots then wedge to the green." },
    { num:14, par:4, si:14, yards:344, danger:false, tip:"Solid bogey golf works here. Same approach, same result." },
    { num:15, par:4, si:2,  yards:389, danger:true,  tip:"SI 2 means this is tough. Fairway priority. Stay conservative." },
    { num:16, par:3, si:10, yards:180, danger:false, tip:"Aim for the fat part of the green. No heroics needed." },
    { num:17, par:5, si:6,  yards:514, danger:true,  tip:"YOUR WORST HOLE. Lay up to 80-100y. Do NOT go for the green in two." },
    { num:18, par:3, si:16, yards:167, danger:false, tip:"Strong finish. You've earned it. Confidence and a smile." },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentHole = 0;
let playingHC   = 27;
let targetHC    = 16;
let playerName  = 'Rajiv';
let roundDate   = '';
let courseId    = null;
let holeIds     = [];
let recentRounds = [];
let holeStats   = []; // per-hole averages from DB

let holeData = Array.from({length:18}, () => ({ score:null, putts:null, fairway:null, gir:null }));

let statsCharts = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('setup-date').value = new Date().toISOString().split('T')[0];

async function init() {
    await loadCourseData();
    await loadHomeData();
}

async function loadCourseData() {
    try {
        const { data: course } = await sb.from('courses').select('id').eq('slug','hoebridge-golf-centre').single();
        if (course) {
            courseId = course.id;
            const { data: holes } = await sb.from('holes').select('id,hole_number').eq('course_id', courseId).order('hole_number');
            if (holes) holeIds = holes.map(h => h.id);
        }
    } catch(e) { console.warn('Course load:', e); }
}

async function loadHomeData() {
    try {
        // Get user prefs
        const { data: prefs } = await sb.from('user_preferences').select('*').limit(1).single();
        if (prefs) {
            playerName = prefs.name || 'Rajiv';
            playingHC  = prefs.current_handicap || 27;
            targetHC   = prefs.target_handicap  || 16;
        }

        document.getElementById('home-name').textContent = playerName;
        document.getElementById('setup-name').value = playerName;
        document.getElementById('setup-hc').value   = playingHC;
        document.getElementById('home-hc').value = playingHC.toFixed(1);
        document.getElementById('home-target-hc').value = targetHC;

        // HC bar â€” how far progressed from starting HC (assume 28 start) to target
        const startHC = 28;
        const progress = Math.min(100, Math.max(0, ((startHC - playingHC) / (startHC - targetHC)) * 100));
        document.getElementById('home-hc-bar').style.width = progress + '%';

        const needed = playingHC - targetHC;
        document.getElementById('home-hc-bar-lbl').textContent =
            needed > 0 ? `${needed.toFixed(1)} shots to go` : 'ğŸ‰ Target reached!';

        // Load recent rounds
        const { data: rounds } = await sb.from('rounds')
            .select('*').order('date', {ascending:false}).limit(20);

        recentRounds = rounds || [];
        document.getElementById('home-rounds-played').textContent = `${recentRounds.length} rounds logged`;

        renderHomeRounds();
        updateHomeStats();

    } catch(e) { console.warn('Home data:', e); }
}

function renderHomeRounds() {
    const list = document.getElementById('home-rounds-list');
    if (!recentRounds.length) {
        list.innerHTML = `<div class="empty-state">
            <div class="empty-state-icon">â›³</div>
            <div class="empty-state-title">No rounds yet</div>
            <div class="empty-state-text">Play your first round and it'll appear here with full stats and hole breakdowns.</div>
        </div>`;
        return;
    }

    list.innerHTML = '';
    recentRounds.slice(0,5).forEach((r, i) => {
        const pts = r.stableford_points || 0;
        const pStyle = getPointsStyle(pts);
        const prev = recentRounds[i+1];
        const trend = prev ? (pts > prev.stableford_points ? 'â†‘' : pts < prev.stableford_points ? 'â†“' : 'â†’') : '';
        const trendColor = trend === 'â†‘' ? 'var(--green-bright)' : trend === 'â†“' ? 'var(--red)' : 'var(--gray)';
        const d = new Date(r.date + 'T12:00:00');
        const row = document.createElement('div');
        row.className = 'round-row';
        row.innerHTML = `
            <div class="round-row-date">
                <div class="round-row-date-main">${d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</div>
                <div class="round-row-date-sub">HC ${r.playing_handicap || playingHC}</div>
            </div>
            <span class="trend-arrow" style="color:${trendColor}">${trend}</span>
            <div class="round-row-score">${r.total_score || 'â€”'}</div>
            <div class="round-row-pts" style="background:${pStyle.bg}22;color:${pStyle.bg};border:1px solid ${pStyle.bg}44">
                ${pts} pts
            </div>`;
        list.appendChild(row);
    });
}

function updateHomeStats() {
    if (!recentRounds.length) return;
    const pts   = recentRounds.map(r => r.stableford_points || 0);
    const scores = recentRounds.filter(r => r.total_score).map(r => r.total_score);
    const avgPts   = (pts.reduce((a,b)=>a+b,0) / pts.length).toFixed(1);
    const avgScore = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 'â€”';
    const bestPts  = Math.max(...pts);
    document.getElementById('home-avg-pts').textContent   = avgPts;
    document.getElementById('home-avg-score').textContent = avgScore;
    document.getElementById('home-best-pts').textContent  = bestPts;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStats() {
    const scroll = document.getElementById('stats-scroll');
    scroll.innerHTML = '<div class="loading-overlay"><div class="spinner"></div> Crunching your numbers...</div>';

    // Destroy old charts
    Object.values(statsCharts).forEach(c => c.destroy());
    statsCharts = {};

    try {
        // Load rounds with shots
        const { data: rounds } = await sb.from('rounds')
            .select('*, shots(*)').order('date',{ascending:false}).limit(20);

        if (!rounds || !rounds.length) {
            scroll.innerHTML = `<div class="empty-state" style="padding:60px 20px">
                <div class="empty-state-icon">ğŸ“Š</div>
                <div class="empty-state-title">No Data Yet</div>
                <div class="empty-state-text">Complete and save a round to see your full performance dashboard here.</div>
            </div>`;
            return;
        }

        document.getElementById('stats-sub').textContent = `Last ${rounds.length} round${rounds.length>1?'s':''} Â· Hoebridge`;

        // Compute per-hole stats
        const holeAgg = Array.from({length:18}, (_,i) => ({
            num: i+1, par: HOLES[i].par, si: HOLES[i].si,
            scores: [], putts: [], girs: 0, firs: 0, count: 0,
        }));

        rounds.forEach(r => {
            (r.shots || []).forEach(s => {
                const idx = s.hole_number - 1;
                if (idx < 0 || idx > 17) return;
                if (s.score) { holeAgg[idx].scores.push(s.score); holeAgg[idx].count++; }
                if (s.putts) holeAgg[idx].putts.push(s.putts);
                if (s.gir  === true)  holeAgg[idx].girs++;
                if (s.fairway === 'C') holeAgg[idx].firs++;
            });
        });

        holeStats = holeAgg.map(h => {
            const avg = h.scores.length ? h.scores.reduce((a,b)=>a+b,0)/h.scores.length : null;
            const avgPutts = h.putts.length ? h.putts.reduce((a,b)=>a+b,0)/h.putts.length : null;
            const girPct = h.count ? Math.round((h.girs/h.count)*100) : null;
            const firPct = (h.par > 3 && h.count) ? Math.round((h.firs/h.count)*100) : null;
            // Target score: par + shots received based on targetHC
            const shotsRec = Math.floor(targetHC/18) + (h.si <= (targetHC%18) ? 1 : 0);
            const targetScore = h.par + shotsRec; // at target HC, expect to score net par = par + shots rec
            return { ...h, avg, avgPutts, girPct, firPct, targetScore };
        });

        scroll.innerHTML = '';

        // â”€â”€ Overall summary â”€â”€
        const totalPts   = rounds.map(r=>r.stableford_points||0);
        const totalScore = rounds.filter(r=>r.total_score).map(r=>r.total_score);
        const totalPutts = rounds.filter(r=>r.total_putts).map(r=>r.total_putts);

        const sumSection = document.createElement('div');
        sumSection.className = 'sum-grid';
        sumSection.innerHTML = `
            <div class="sum-card" style="grid-column:1/-1;background:var(--card2);border-color:var(--border2)">
                <div class="sum-card-val" style="font-size:48px">${(totalPts.reduce((a,b)=>a+b,0)/totalPts.length).toFixed(1)}</div>
                <div class="sum-card-lbl">Avg Stableford Points</div>
            </div>
            <div class="sum-card">
                <div class="sum-card-val">${totalScore.length ? Math.round(totalScore.reduce((a,b)=>a+b,0)/totalScore.length) : 'â€”'}</div>
                <div class="sum-card-lbl">Avg Gross Score</div>
            </div>
            <div class="sum-card">
                <div class="sum-card-val">${Math.max(...totalPts)}</div>
                <div class="sum-card-lbl">Best Points</div>
            </div>
            <div class="sum-card">
                <div class="sum-card-val">${totalPutts.length ? Math.round(totalPutts.reduce((a,b)=>a+b,0)/totalPutts.length) : 'â€”'}</div>
                <div class="sum-card-lbl">Avg Putts</div>
            </div>
            <div class="sum-card">
                <div class="sum-card-val">${rounds.length}</div>
                <div class="sum-card-lbl">Rounds Logged</div>
            </div>`;
        scroll.appendChild(sumSection);

        // â”€â”€ Data setup â”€â”€
        const sortedRounds = [...rounds].reverse(); // oldest first
        const scorePoints  = sortedRounds.filter(r=>r.total_score).map(r => ({ x: new Date(r.date+'T12:00:00').getTime(), y: r.total_score }));
        const ptsPoints    = sortedRounds.filter(r=>r.stableford_points).map(r => ({ x: new Date(r.date+'T12:00:00').getTime(), y: r.stableford_points }));
        const puttsPoints  = sortedRounds.filter(r=>r.total_putts).map(r => ({ x: new Date(r.date+'T12:00:00').getTime(), y: r.total_putts }));

        const scoreReg = linearRegression(scorePoints);
        const ptsReg   = linearRegression(ptsPoints);

        const targetScore = calcTargetGrossScore(targetHC);
        const targetPts   = 36;

        const projByScore = scoreReg ? projectDate(scoreReg, targetScore, 'down') : null;
        const projByPts   = ptsReg   ? projectDate(ptsReg,   targetPts,  'up')   : null;

        // Extended labels â€” go to the furthest projection date
        const lastRoundDate = new Date(sortedRounds[sortedRounds.length-1].date+'T12:00:00');
        const projEndDate   = projByScore && projByPts 
            ? new Date(Math.max(projByScore.getTime(), projByPts.getTime()))
            : projByScore || projByPts || new Date(lastRoundDate.getTime() + 180*24*60*60*1000);

        // Build extended x-axis: all round dates + monthly steps to projection end
        const extendedDates = [...sortedRounds.map(r => new Date(r.date+'T12:00:00'))];
        let cursor = new Date(lastRoundDate);
        cursor.setDate(1);
        cursor.setMonth(cursor.getMonth()+1);
        while (cursor <= projEndDate) {
            extendedDates.push(new Date(cursor));
            cursor.setMonth(cursor.getMonth()+1);
        }
        // Deduplicate and sort
        const extDedupe = [...new Map(extendedDates.map(d=>[d.toDateString(),d])).values()].sort((a,b)=>a-b);
        const extLabels = extDedupe.map(d => d.toLocaleDateString('en-GB',{day:'numeric',month:'short'}));
        const extMs     = extDedupe.map(d => d.getTime());

        // Map actual round data to extended labels
        const roundMs = sortedRounds.map(r => new Date(r.date+'T12:00:00').getTime());
        const mapToExt = (arr, key) => extMs.map(ms => {
            const idx = roundMs.indexOf(ms);
            return idx >= 0 ? (arr[idx][key] || null) : null;
        });

        const extScoreData = extMs.map(ms => {
            const idx = roundMs.indexOf(ms);
            return idx >= 0 ? (sortedRounds[idx].total_score || null) : null;
        });
        const extPtsData = extMs.map(ms => {
            const idx = roundMs.indexOf(ms);
            return idx >= 0 ? (sortedRounds[idx].stableford_points || null) : null;
        });
        const extPuttsData = extMs.map(ms => {
            const idx = roundMs.indexOf(ms);
            return idx >= 0 ? (sortedRounds[idx].total_putts || null) : null;
        });

        // Trend lines across full extended range
        const extScoreTrend = scoreReg ? extMs.map(ms => parseFloat(scoreReg.predict(ms).toFixed(1))) : null;
        const extPtsTrend   = ptsReg   ? extMs.map(ms => parseFloat(ptsReg.predict(ms).toFixed(1)))   : null;

        const fmtProj = d => d ? d.toLocaleDateString('en-GB',{month:'short',year:'numeric'}) : 'Keep playing!';

        // â”€â”€ Projection cards â”€â”€
        const projCard = document.createElement('div');
        projCard.className = 'chart-card';
        projCard.innerHTML = `
            <div class="chart-title">HC ${targetHC} Projection</div>
            <div class="chart-sub">Based on your improvement rate â€” two methods</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
                <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
                    <div style="font-size:9px;color:var(--gray);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Via Score</div>
                    <div style="font-family:var(--font-display);font-size:20px;color:var(--green-bright)">${fmtProj(projByScore)}</div>
                    <div style="font-size:10px;color:var(--gray);margin-top:4px">Target ${targetScore} gross</div>
                </div>
                <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
                    <div style="font-size:9px;color:var(--gray);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Via Points</div>
                    <div style="font-family:var(--font-display);font-size:20px;color:var(--sand)">${fmtProj(projByPts)}</div>
                    <div style="font-size:10px;color:var(--gray);margin-top:4px">Target 36 pts avg</div>
                </div>
            </div>
            <div style="font-size:11px;color:var(--gray);margin-top:12px;line-height:1.5;font-style:italic">
                Score trend is more conservative (raw improvement). Points trend reflects handicap-adjusted form. Truth is between the two.
            </div>`;
        scroll.appendChild(projCard);

        // â”€â”€ Points trend chart (extended to projection) â”€â”€
        const trendCard = document.createElement('div');
        trendCard.className = 'chart-card';
        trendCard.innerHTML = `
            <div class="chart-title">Points Trend</div>
            <div class="chart-sub">Stableford points â€” projected to HC ${targetHC} target</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-trend"></canvas></div>`;
        scroll.appendChild(trendCard);

        await sleep(50);
        statsCharts.trend = new Chart(document.getElementById('chart-trend'), {
            type: 'line',
            data: {
                labels: extLabels,
                datasets: [
                    {
                        label: 'Points',
                        data: extPtsData,
                        borderColor: '#52b788',
                        backgroundColor: 'rgba(82,183,136,0.08)',
                        fill: true, tension: 0.4,
                        pointBackgroundColor: '#52b788',
                        pointRadius: extPtsData.map(v => v !== null ? 4 : 0),
                        spanGaps: false,
                    },
                    {
                        label: 'Trend',
                        data: extPtsTrend,
                        borderColor: 'rgba(82,183,136,0.4)',
                        borderDash: [4,4], borderWidth: 1.5,
                        pointRadius: 0, fill: false,
                    },
                    {
                        label: 'Target 36',
                        data: extLabels.map(() => 36),
                        borderColor: '#e9c46a',
                        borderDash: [6,4], borderWidth: 1.5,
                        pointRadius: 0, fill: false,
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color:'#8fa898', font:{size:10}, boxWidth:10 } } },
                scales: {
                    x: { ticks:{color:'#8fa898',font:{size:9},maxTicksLimit:8}, grid:{color:'rgba(255,255,255,0.04)'} },
                    y: { ticks:{color:'#8fa898',font:{size:10}}, grid:{color:'rgba(255,255,255,0.06)'}, min:15, max:45 }
                }
            }
        });

        // â”€â”€ Score vs target chart (extended) â”€â”€
        const scoreCard = document.createElement('div');
        scoreCard.className = 'chart-card';
        scoreCard.innerHTML = `
            <div class="chart-title">Score vs Target</div>
            <div class="chart-sub">Gross score â€” projected to HC ${targetHC} target (${targetScore})</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-score-trend"></canvas></div>`;
        scroll.appendChild(scoreCard);

        await sleep(50);
        statsCharts.scoreTrend = new Chart(document.getElementById('chart-score-trend'), {
            type: 'line',
            data: {
                labels: extLabels,
                datasets: [
                    {
                        label: 'Gross Score',
                        data: extScoreData,
                        borderColor: '#74b3ce',
                        backgroundColor: 'rgba(116,179,206,0.08)',
                        fill: true, tension: 0.3,
                        pointBackgroundColor: '#74b3ce',
                        pointRadius: extScoreData.map(v => v !== null ? 4 : 0),
                        spanGaps: false,
                    },
                    {
                        label: 'Trend',
                        data: extScoreTrend,
                        borderColor: 'rgba(244,162,97,0.5)',
                        borderDash: [4,4], borderWidth: 1.5,
                        pointRadius: 0, fill: false,
                    },
                    {
                        label: `Target ${targetScore}`,
                        data: extLabels.map(() => targetScore),
                        borderColor: '#52b788',
                        borderDash: [6,4], borderWidth: 1.5,
                        pointRadius: 0, fill: false,
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color:'#8fa898', font:{size:10}, boxWidth:10 } } },
                scales: {
                    x: { ticks:{color:'#8fa898',font:{size:9},maxTicksLimit:8}, grid:{color:'rgba(255,255,255,0.04)'} },
                    y: { ticks:{color:'#8fa898',font:{size:10}}, grid:{color:'rgba(255,255,255,0.06)'}, reverse:true }
                }
            }
        });

        // â”€â”€ Putts per round trend â”€â”€
        const puttsCard = document.createElement('div');
        puttsCard.className = 'chart-card';
        puttsCard.innerHTML = `
            <div class="chart-title">Putts Per Round</div>
            <div class="chart-sub">Lower is better â€” tour average ~30, target for HC 16: ~34</div>
            <div class="chart-wrap" style="height:180px"><canvas id="chart-putts"></canvas></div>`;
        scroll.appendChild(puttsCard);

        await sleep(50);
        const puttsReg = linearRegression(puttsPoints);
        const extPuttsTrend = puttsReg ? extMs.map(ms => parseFloat(puttsReg.predict(ms).toFixed(1))) : null;
        statsCharts.putts = new Chart(document.getElementById('chart-putts'), {
            type: 'line',
            data: {
                labels: extLabels,
                datasets: [
                    {
                        label: 'Putts',
                        data: extPuttsData,
                        borderColor: '#c77dff',
                        backgroundColor: 'rgba(199,125,255,0.08)',
                        fill: true, tension: 0.4,
                        pointBackgroundColor: '#c77dff',
                        pointRadius: extPuttsData.map(v => v !== null ? 4 : 0),
                        spanGaps: false,
                    },
                    {
                        label: 'Trend',
                        data: extPuttsTrend,
                        borderColor: 'rgba(199,125,255,0.4)',
                        borderDash: [4,4], borderWidth: 1.5,
                        pointRadius: 0, fill: false,
                    },
                    {
                        label: 'Target 34',
                        data: extLabels.map(() => 34),
                        borderColor: '#52b788',
                        borderDash: [6,4], borderWidth: 1.5,
                        pointRadius: 0, fill: false,
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color:'#8fa898', font:{size:10}, boxWidth:10 } } },
                scales: {
                    x: { ticks:{color:'#8fa898',font:{size:9},maxTicksLimit:8}, grid:{color:'rgba(255,255,255,0.04)'} },
                    y: { ticks:{color:'#8fa898',font:{size:10}}, grid:{color:'rgba(255,255,255,0.06)'}, min:28, max:46 }
                }
            }
        });

        // â”€â”€ Scoring zones donut â”€â”€
        const zoneCounts = {eagle:0,birdie:0,par:0,bogey:0,double:0,triple:0,worse:0};
        rounds.forEach(r => {
            (r.shots||[]).forEach(s => {
                if (!s.score) return;
                const h = HOLES[s.hole_number-1];
                const diff = s.score - h.par;
                if (diff <= -2) zoneCounts.eagle++;
                else if (diff === -1) zoneCounts.birdie++;
                else if (diff === 0) zoneCounts.par++;
                else if (diff === 1) zoneCounts.bogey++;
                else if (diff === 2) zoneCounts.double++;
                else if (diff === 3) zoneCounts.triple++;
                else zoneCounts.worse++;
            });
        });
        const totalHoles = Object.values(zoneCounts).reduce((a,b)=>a+b,0);

        const zoneRows = [
            {k:'eagle',  label:'Eagle+',      col:'#f6d860'},
            {k:'birdie', label:'Birdie',       col:'#52b788'},
            {k:'par',    label:'Par',          col:'#74b3ce'},
            {k:'bogey',  label:'Bogey',        col:'#f4a261'},
            {k:'double', label:'Double',       col:'#e63946'},
            {k:'triple', label:'Triple',       col:'#888'},
            {k:'worse',  label:'+4 or worse',  col:'#555'},
        ].map(z => {
            const pct = totalHoles ? Math.round((zoneCounts[z.k]/totalHoles)*100) : 0;
            return '<div style="display:flex;align-items:center;gap:6px">'
                + '<div style="width:10px;height:10px;border-radius:2px;background:' + z.col + ';flex-shrink:0"></div>'
                + '<span style="color:var(--gray);flex:1">' + z.label + '</span>'
                + '<span style="color:var(--white);font-weight:600">' + zoneCounts[z.k] + '</span>'
                + '<span style="color:var(--gray)">' + pct + '%</span>'
                + '</div>';
        }).join('');

        const donutCard = document.createElement('div');
        donutCard.className = 'chart-card';
        donutCard.innerHTML = `
            <div class="chart-title">Scoring Zones</div>
            <div class="chart-sub">Breakdown across all ${totalHoles} holes played</div>
            <div style="display:flex;gap:12px;align-items:center">
                <div class="chart-wrap" style="height:180px;flex:1"><canvas id="chart-donut"></canvas></div>
                <div style="flex:1;display:flex;flex-direction:column;gap:6px;font-size:11px">${zoneRows}</div>
            </div>`;
        scroll.appendChild(donutCard);

        await sleep(50);
        statsCharts.donut = new Chart(document.getElementById('chart-donut'), {
            type: 'doughnut',
            data: {
                labels: ['Eagle+','Birdie','Par','Bogey','Double','Triple','+4'],
                datasets: [{
                    data: [zoneCounts.eagle,zoneCounts.birdie,zoneCounts.par,zoneCounts.bogey,zoneCounts.double,zoneCounts.triple,zoneCounts.worse],
                    backgroundColor: ['#f6d860','#52b788','#74b3ce','#f4a261','#e63946','#888','#555'],
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                cutout: '65%',
                plugins: { legend: { display: false } }
            }
        });

        // â”€â”€ Front 9 vs Back 9 â”€â”€
        const f9scores=[], b9scores=[], f9pts=[], b9pts=[];
        rounds.forEach(r => {
            const shots = r.shots || [];
            let f9s=0,b9s=0,f9p=0,b9p=0,f9c=0,b9c=0;
            shots.forEach(s => {
                if (!s.score) return;
                const pts = calcPoints(s.hole_number-1, s.score);
                if (s.hole_number <= 9) { f9s+=s.score; f9p+=pts; f9c++; }
                else { b9s+=s.score; b9p+=pts; b9c++; }
            });
            if (f9c>=9) { f9scores.push(f9s); f9pts.push(f9p); }
            if (b9c>=9) { b9scores.push(b9s); b9pts.push(b9p); }
        });

        const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : null;
        const f9AvgScore = avg(f9scores), b9AvgScore = avg(b9scores);
        const f9AvgPts = avg(f9pts), b9AvgPts = avg(b9pts);

        // Par for each 9
        const f9Par = HOLES.slice(0,9).reduce((a,h)=>a+h.par,0); // 36
        const b9Par = HOLES.slice(9,18).reduce((a,h)=>a+h.par,0); // 36

        const splitCard = document.createElement('div');
        splitCard.className = 'chart-card';

        const halfCards = [
            {label:'Front 9', par:f9Par, avgScore:f9AvgScore, avgPts:f9AvgPts, col:'#74b3ce'},
            {label:'Back 9',  par:b9Par, avgScore:b9AvgScore, avgPts:b9AvgPts, col:'#52b788'},
        ].map(h => {
            const scoreDiff = h.avgScore !== null ? (h.avgScore - h.par).toFixed(1) : null;
            const diffCol = !scoreDiff ? 'var(--gray)' : scoreDiff > 0 ? 'var(--orange)' : 'var(--green-bright)';
            return '<div style="background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center">'
                + '<div style="font-size:11px;color:var(--gray);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">' + h.label + '</div>'
                + '<div style="font-family:var(--font-display);font-size:36px;color:' + h.col + '">' + (h.avgScore ? h.avgScore.toFixed(1) : 'â€”') + '</div>'
                + '<div style="font-size:11px;color:' + diffCol + ';margin-top:2px">' + (scoreDiff ? (scoreDiff > 0 ? '+' : '') + scoreDiff + ' vs par' : '') + '</div>'
                + '<div style="font-size:11px;color:var(--gray);margin-top:8px">' + (h.avgPts ? h.avgPts.toFixed(1) + ' pts avg' : '') + '</div>'
                + '</div>';
        }).join('');

        splitCard.innerHTML = `
            <div class="chart-title">Front 9 vs Back 9</div>
            <div class="chart-sub">Average performance on each half</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">${halfCards}</div>
            <div style="margin-top:12px;font-size:12px;color:var(--gray);line-height:1.5" id="f9b9-insight"></div>`;
        scroll.appendChild(splitCard);

        // Insight text
        if (f9AvgScore && b9AvgScore) {
            const diff = f9AvgScore - b9AvgScore;
            const insight = diff > 1.5
                ? `âš ï¸ You're averaging ${Math.abs(diff).toFixed(1)} shots more on the front 9. Holes 3, 4, 5 and 7 are likely the culprits â€” your danger holes are clustered there.`
                : diff < -1.5
                ? `âš ï¸ You're struggling more on the back 9 (+${Math.abs(diff).toFixed(1)} shots). Holes 11, 13, 15 and 17 need attention â€” especially 17 which is your worst hole.`
                : `âœ… You're remarkably consistent across both halves â€” only ${Math.abs(diff).toFixed(1)} shots difference. That's a good sign of a balanced game.`;
            document.getElementById('f9b9-insight').textContent = insight;
        }

        // â”€â”€ Avg score per hole chart â”€â”€
        const holesWithData = holeStats.filter(h => h.avg !== null);
        if (holesWithData.length) {
            const holeChartCard = document.createElement('div');
            holeChartCard.className = 'chart-card';
            holeChartCard.innerHTML = `
                <div class="chart-title">Score vs Par â€” All Holes</div>
                <div class="chart-sub">Your average score vs par per hole</div>
                <div class="chart-wrap"><canvas id="chart-holes"></canvas></div>`;
            scroll.appendChild(holeChartCard);

            await sleep(50);
            statsCharts.holes = new Chart(document.getElementById('chart-holes'), {
                type: 'bar',
                data: {
                    labels: holeStats.map(h => h.num),
                    datasets: [
                        {
                            label: 'Par',
                            data: holeStats.map(h => h.par),
                            backgroundColor: 'rgba(116,179,206,0.3)',
                            borderColor: '#74b3ce',
                            borderWidth: 1,
                        },
                        {
                            label: 'Your Avg',
                            data: holeStats.map(h => h.avg ? parseFloat(h.avg.toFixed(1)) : null),
                            backgroundColor: holeStats.map(h => {
                                if (!h.avg) return 'rgba(100,100,100,0.3)';
                                const diff = h.avg - h.par;
                                if (diff <= 0) return 'rgba(82,183,136,0.7)';
                                if (diff <= 1) return 'rgba(244,162,97,0.7)';
                                return 'rgba(230,57,70,0.7)';
                            }),
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#8fa898', font: { size: 10 } } } },
                    scales: {
                        x: { ticks: { color: '#8fa898', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                        y: { ticks: { color: '#8fa898', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.06)' }, min: 2 }
                    }
                }
            });
        }

        // â”€â”€ GIR % chart â”€â”€
        const girData = holeStats.map(h => h.girPct);
        if (girData.some(v => v !== null)) {
            const girCard = document.createElement('div');
            girCard.className = 'chart-card';
            girCard.innerHTML = `
                <div class="chart-title">Greens in Regulation %</div>
                <div class="chart-sub">How often you hit each green in regulation</div>
                <div class="chart-wrap"><canvas id="chart-gir"></canvas></div>`;
            scroll.appendChild(girCard);

            await sleep(50);
            statsCharts.gir = new Chart(document.getElementById('chart-gir'), {
                type: 'bar',
                data: {
                    labels: holeStats.map(h => h.num),
                    datasets: [{
                        label: 'GIR %',
                        data: girData,
                        backgroundColor: holeStats.map(h => {
                            if (h.girPct === null) return 'rgba(100,100,100,0.3)';
                            if (h.girPct >= 50) return 'rgba(82,183,136,0.7)';
                            if (h.girPct >= 25) return 'rgba(244,162,97,0.6)';
                            return 'rgba(230,57,70,0.6)';
                        }),
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#8fa898', font:{ size:10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                        y: { ticks: { color: '#8fa898', font:{size:10}, callback: v => v+'%' }, grid: { color: 'rgba(255,255,255,0.06)' }, min:0, max:100 }
                    }
                }
            });
        }

        // â”€â”€ Hole-by-hole breakdown table â”€â”€
        const tableEl = document.createElement('div');
        tableEl.className = 'hole-table';
        tableEl.innerHTML = `
            <div class="hole-table-header">
                <div class="hole-table-title">Hole Breakdown</div>
                <div class="hole-table-sub">Avg score, target, GIR% and coaching advice</div>
            </div>
            <div class="ht-row header-row">
                <div class="ht-col">#</div>
                <div class="ht-col">Par</div>
                <div class="ht-col">Avg</div>
                <div class="ht-col">Target</div>
                <div class="ht-col">GIR%</div>
                <div class="ht-col left">Advice</div>
            </div>
            ${holeStats.map(h => {
                const avgDisplay = h.avg !== null ? h.avg.toFixed(1) : 'â€”';
                const diff = h.avg !== null ? h.avg - h.par : null;
                let ratingClass = '';
                if (diff !== null) {
                    if (diff <= -1) ratingClass = 'rating-birdie';
                    else if (diff < 0.5) ratingClass = 'rating-par';
                    else if (diff < 1.5) ratingClass = 'rating-bogey';
                    else if (diff < 2.5) ratingClass = 'rating-double';
                    else ratingClass = 'rating-worse';
                }

                const { tag, tagClass, advice } = getHoleAdvice(h);

                return `<div class="ht-row">
                    <div class="ht-num">${h.num}</div>
                    <div class="ht-par">${h.par}</div>
                    <div class="ht-avg ${ratingClass}">${avgDisplay}</div>
                    <div class="ht-target">${h.targetScore}</div>
                    <div class="ht-gir">${h.girPct !== null ? h.girPct+'%' : 'â€”'}</div>
                    <div class="ht-advice">
                        <span class="tag ${tagClass}">${tag}</span><br>${advice}
                    </div>
                </div>`;
            }).join('')}`;
        scroll.appendChild(tableEl);

        // â”€â”€ Round history â”€â”€
        const histHeader = document.createElement('div');
        histHeader.innerHTML = '<div class="section-title" style="padding:4px 4px 12px">Round History</div>';
        scroll.appendChild(histHeader);

        const histList = document.createElement('div');
        histList.style.cssText = 'display:flex;flex-direction:column;gap:8px;padding-bottom:24px';
        rounds.forEach(r => {
            const pts = r.stableford_points||0;
            const ps = getPointsStyle(pts);
            const d = new Date(r.date+'T12:00:00');
            const dateStr = d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
            const item = document.createElement('div');
            item.className = 'round-history-item';
            item.innerHTML = `
                <div class="rhi-left">
                    <div class="rhi-date">${dateStr}</div>
                    <div class="rhi-sub">HC ${r.playing_handicap||'?'} Â· ${r.total_putts||'?'} putts Â· ${r.gir_count||0} GIR</div>
                </div>
                <div class="rhi-score">${r.total_score||'â€”'}</div>
                <div class="rhi-pts" style="background:${ps.bg}22;color:${ps.bg};border:1px solid ${ps.bg}44">${pts} pts</div>
                <button class="rhi-delete" onclick="confirmDelete('${r.id}','${dateStr}')" title="Delete round">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/>
                    </svg>
                </button>`;
            histList.appendChild(item);
        });
        scroll.appendChild(histList);

    } catch(e) {
        scroll.innerHTML = `<div class="empty-state" style="padding:60px 20px">
            <div class="empty-state-icon">âš ï¸</div>
            <div class="empty-state-title">Could not load stats</div>
            <div class="empty-state-text">${e.message}</div>
        </div>`;
        console.error(e);
    }
}

function getHoleAdvice(h) {
    if (h.avg === null) return { tag:'No Data', tagClass:'tag-average', advice: HOLES[h.num-1].tip };
    const diff = h.avg - h.par;
    const girOk = h.girPct !== null && h.girPct >= 33;
    const puttOk = h.avgPutts !== null && h.avgPutts <= 2.2;

    if (diff <= 0.5) {
        return { tag:'Strength ğŸ’ª', tagClass:'tag-strength', advice:`Averaging ${h.avg.toFixed(1)} here. This is one of your best holes â€” keep doing exactly what you're doing.` };
    }
    if (diff <= 1.2) {
        if (!girOk) return { tag:'Approach Issue', tagClass:'tag-average', advice:`Avg ${h.avg.toFixed(1)}. GIR only ${h.girPct??0}% â€” work on getting closer with approach. Club selection review.` };
        if (!puttOk) return { tag:'Putting Cost', tagClass:'tag-average', advice:`Avg ${h.avg.toFixed(1)}. Approach is reasonable but averaging ${h.avgPutts?.toFixed(1)??'?'} putts. Focus on lag putting.` };
        return { tag:'On Track', tagClass:'tag-strength', advice:`Avg ${h.avg.toFixed(1)} against par ${h.par}. Close to target ${h.targetScore}. Keep it consistent.` };
    }
    if (diff <= 2) {
        if (h.par === 3) return { tag:'Problem Hole', tagClass:'tag-problem', advice:`Avg ${h.avg.toFixed(1)} on this par 3. Focus on the right club â€” aim centre of green, not the flag.` };
        if (!girOk) return { tag:'Problem Hole', tagClass:'tag-problem', advice:`Avg ${h.avg.toFixed(1)}. Only ${h.girPct??0}% GIR. Lay up to a comfortable yardage rather than going for it. Target: ${h.targetScore}.` };
        return { tag:'Problem Hole', tagClass:'tag-problem', advice:`Avg ${h.avg.toFixed(1)}. You're ${diff.toFixed(1)} over par here. Simplify the strategy: fairway, lay-up, wedge, 2 putts.` };
    }
    return { tag:'Danger Zone ğŸ”´', tagClass:'tag-problem', advice:`Avg ${h.avg.toFixed(1)} â€” ${diff.toFixed(1)} over par. This hole is costing you most. Reframe success as bogey. Accept double and move on.` };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORING HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getShotsReceived(idx) {
    const si = HOLES[idx].si;
    return Math.floor(playingHC/18) + (si <= (playingHC%18) ? 1 : 0);
}

function calcPoints(idx, score) {
    if (!score) return 0;
    const net = score - getShotsReceived(idx);
    return Math.max(0, HOLES[idx].par - net + 2);
}

function getTotalPoints() {
    return holeData.reduce((sum,h,i) => sum + (h.score ? calcPoints(i,h.score) : 0), 0);
}

function getScoreLabel(par, score) {
    const d = score - par;
    if (d <= -2) return 'Eagle'; if (d===-1) return 'Birdie'; if (d===0) return 'Par';
    if (d===1) return 'Bogey'; if (d===2) return 'Double'; if (d===3) return 'Triple';
    return '+'+d;
}

function getScoreClass(par, score) {
    const d = score - par;
    if (d <= -2) return 'eagle'; if (d===-1) return 'birdie'; if (d===0) return 'par';
    if (d===1) return 'bogey'; if (d===2) return 'double'; if (d===3) return 'triple';
    return 'more';
}

function getPointsStyle(pts) {
    if (pts >= 4) return { bg:'#f6d860' };
    if (pts === 3) return { bg:'#52b788' };
    if (pts === 2) return { bg:'#74b3ce' };
    if (pts === 1) return { bg:'#f4a261' };
    return { bg:'#475569' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAY SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startRound() {
    playerName = document.getElementById('setup-name').value.trim() || 'Golfer';
    playingHC  = parseInt(document.getElementById('setup-hc').value) || 27;
    roundDate  = document.getElementById('setup-date').value;
    holeData   = Array.from({length:18}, () => ({score:null,putts:null,fairway:null,gir:null}));
    showScreen('screen-play');
    // Ensure holeStats are loaded for caddie briefing
    if (!holeStats.length) await loadStats();
    renderHole(0);
}

// â”€â”€ Caddie briefing collapse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let briefingCollapsed = false;
function toggleBriefing() {
    briefingCollapsed = !briefingCollapsed;
    const el = document.getElementById('caddie-briefing');
    el.classList.toggle('collapsed', briefingCollapsed);
}

// â”€â”€ Pace calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPaceInfo(holesPlayed, currentPts) {
    if (!recentRounds.length || holesPlayed === 0) return null;
    const avgPtsPerHole = recentRounds
        .filter(r => r.stableford_points)
        .reduce((s,r) => s + r.stableford_points, 0) / recentRounds.filter(r=>r.stableford_points).length / 18;
    const bestRound = Math.max(...recentRounds.filter(r=>r.stableford_points).map(r=>r.stableford_points));
    const projectedTotal = (currentPts / holesPlayed) * 18;
    const avgProjected   = avgPtsPerHole * 18;
    return { projectedTotal, avgProjected, bestRound };
}

// â”€â”€ Momentum detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMomentum(upToHole) {
    // Look at last 3 completed holes
    if (upToHole < 3) return null;
    const last3 = [];
    for (let i = upToHole - 3; i < upToHole; i++) {
        if (!holeData[i].score) return null;
        const pts = calcPoints(i, holeData[i].score);
        const hStat = holeStats[i];
        const avg = hStat?.avg || (HOLES[i].par + 1.5); // fallback avg
        last3.push({ pts, score: holeData[i].score, avg });
    }
    const allAboveAvg = last3.every(h => h.score <= h.avg);
    const allBelowAvg = last3.every(h => h.score >= h.avg + 1);
    const totalPts = last3.reduce((s,h) => s+h.pts, 0);
    if (totalPts >= 8) return { type:'hot',  icon:'ğŸ”¥', text:'On fire! 3 holes above average in a row' };
    if (totalPts >= 6 && allAboveAvg) return { type:'good', icon:'ğŸ’ª', text:'Solid run â€” keep this going' };
    if (totalPts <= 2 && allBelowAvg) return { type:'cold', icon:'ğŸ§Š', text:'Tough spell â€” reset, breathe, back to basics' };
    return null;
}

// â”€â”€ Milestone check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkMilestone(idx) {
    if (idx !== 9) return null; // only halfway for now
    const f9pts  = holeData.slice(0,9).reduce((s,h,i) => s + (h.score ? calcPoints(i,h.score) : 0), 0);
    const f9avg  = recentRounds.length
        ? recentRounds.reduce((s,r) => {
            const f9shots = (r.shots||[]).filter(s=>s.hole_number<=9);
            return s + f9shots.reduce((ss,s)=>ss+calcPoints(s.hole_number-1,s.score),0);
        }, 0) / recentRounds.length
        : null;
    const projTotal = f9pts * 2;
    const best = Math.max(...recentRounds.filter(r=>r.stableford_points).map(r=>r.stableford_points), 0);
    let sub = `Front 9: ${f9pts} pts`;
    if (projTotal >= best && best > 0) sub += ` Â· ğŸ† On pace to beat your best (${best} pts)!`;
    else if (f9avg !== null) sub += ` Â· Projected: ~${projTotal} pts (avg: ${Math.round(f9avg*2)})`;
    return { icon:'ğŸ', title:'Halfway There!', sub };
}

// â”€â”€ Post-hole feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showHoleFeedback(fromIdx) {
    const h    = HOLES[fromIdx];
    const d    = holeData[fromIdx];
    if (!d.score) return;
    const pts  = calcPoints(fromIdx, d.score);
    const ps   = getPointsStyle(pts);
    const stat = holeStats[fromIdx];

    const fb   = document.getElementById('hole-feedback');
    fb.style.background = ps.bg + '18';
    fb.style.border     = `1px solid ${ps.bg}44`;
    fb.style.color      = ps.bg;
    fb.classList.add('visible');

    document.getElementById('feedback-pts').textContent  = pts + ' pt' + (pts!==1?'s':'');
    document.getElementById('feedback-pts').style.color  = ps.bg;
    document.getElementById('feedback-label').textContent = getScoreLabel(h.par, d.score) + ` on Hole ${h.num}`;

    // vs average
    let vsText = '';
    if (stat?.avg !== null && stat?.avg !== undefined) {
        const diff = d.score - stat.avg;
        if (diff < -0.5)      vsText = `${Math.abs(diff).toFixed(1)} shots better than your average here âœ…`;
        else if (diff < 0.5)  vsText = `Right on your average for this hole`;
        else                   vsText = `${diff.toFixed(1)} shots above your average â€” target is ${stat.targetScore}`;
    }
    document.getElementById('feedback-vs').textContent  = vsText;
    document.getElementById('feedback-vs').style.color  = 'rgba(255,255,255,0.7)';

    // motivational message
    const totalPts = getTotalPoints();
    const holesIn  = holeData.slice(0, fromIdx+1).filter(h=>h.score).length;
    const pace     = getPaceInfo(holesIn, totalPts);
    let msg = '';
    if (pts >= 4)      msg = "Eagle or better â€” that's what dreams are made of! ğŸ¦…";
    else if (pts === 3) msg = "Birdie! Keep attacking. You're playing well. ğŸ¦";
    else if (pts === 2) msg = "Par â€” banker point in the bag. Solid. ğŸ’¼";
    else if (pts === 1) msg = "Bogey â€” still a point. Reset and move on. ğŸ‘Š";
    else if (pts === 0 && d.score <= h.par + 3) msg = "Tough one. Forget it â€” next hole is a fresh start.";
    else msg = "Rough hole. Deep breath. The card's still in play.";
    document.getElementById('feedback-msg').textContent = msg;
    document.getElementById('feedback-msg').style.color = 'rgba(255,255,255,0.6)';
}

function renderHole(idx, fromPrev) {
    currentHole = idx;
    const h = HOLES[idx];
    const d = holeData[idx];
    const isPar3 = h.par === 3;

    // Hide feedback/milestone/momentum on new hole render (unless coming from prev)
    document.getElementById('hole-feedback').classList.remove('visible');
    document.getElementById('milestone-banner').classList.remove('visible');
    document.getElementById('momentum-badge').classList.remove('visible');

    // Topbar
    document.getElementById('tb-hole').textContent  = `HOLE ${h.num}`;
    document.getElementById('tb-par').textContent   = h.par;
    document.getElementById('tb-si').textContent    = h.si;
    document.getElementById('tb-yards').textContent = h.yards;

    const totalPts   = getTotalPoints();
    const holesPlayed = holeData.slice(0, idx).filter(h=>h.score).length;
    document.getElementById('tb-pts').textContent = totalPts;

    // Pace badge
    const paceEl = document.getElementById('tb-pace');
    if (holesPlayed >= 3) {
        const pace = getPaceInfo(holesPlayed, totalPts);
        if (pace) {
            paceEl.style.display = 'block';
            const proj = Math.round(pace.projectedTotal);
            const diff = proj - Math.round(pace.avgProjected);
            if (diff >= 2) {
                paceEl.textContent = `â†‘ On pace for ${proj} pts`;
                paceEl.className = 'topbar-pace pace-ahead';
            } else if (diff <= -2) {
                paceEl.textContent = `â†“ Pace: ~${proj} pts`;
                paceEl.className = 'topbar-pace pace-behind';
            } else {
                paceEl.textContent = `â†’ Avg pace: ~${proj} pts`;
                paceEl.className = 'topbar-pace pace-on';
            }
        }
    } else {
        paceEl.style.display = 'none';
    }

    document.getElementById('progress-fill').style.width = `${(idx/18)*100}%`;

    // Hole info card
    const card = document.getElementById('hole-info-card');
    card.className = `hole-info-card${h.danger?' danger':''}`;
    document.getElementById('hi-num').textContent   = h.num;
    document.getElementById('hi-par').textContent   = `Par ${h.par}`;
    document.getElementById('hi-si').textContent    = `SI ${h.si}`;
    document.getElementById('hi-yards').textContent = h.yards;
    document.getElementById('hi-danger').style.display = h.danger ? 'block' : 'none';

    // Caddie briefing
    const hStat   = holeStats[idx];
    const shotsRec = getShotsReceived(idx);
    document.getElementById('cb-hole-num').textContent = h.num;
    document.getElementById('cb-shots').textContent    = shotsRec;
    document.getElementById('cb-target').textContent   = hStat?.targetScore ?? (h.par + shotsRec);
    document.getElementById('cb-rounds').textContent   = hStat?.count ?? 'â€”';

    if (hStat?.avg !== null && hStat?.avg !== undefined) {
        const avgCol = hStat.avg - h.par <= 0.5 ? 'var(--green-bright)' : hStat.avg - h.par <= 1.5 ? 'var(--orange)' : 'var(--red)';
        document.getElementById('cb-avg').textContent  = hStat.avg.toFixed(1);
        document.getElementById('cb-avg').style.color  = avgCol;
    } else {
        document.getElementById('cb-avg').textContent  = 'â€”';
        document.getElementById('cb-avg').style.color  = 'var(--gray)';
    }

    document.getElementById('cb-gir').textContent   = hStat?.girPct  !== null && hStat?.girPct  !== undefined ? hStat.girPct  + '%' : 'â€”';
    document.getElementById('cb-putts').textContent = hStat?.avgPutts !== null && hStat?.avgPutts !== undefined ? hStat.avgPutts.toFixed(1) : 'â€”';
    document.getElementById('cb-strategy').textContent = h.tip;

    const dangerBlock = document.getElementById('cb-danger-block');
    if (h.danger) {
        dangerBlock.style.display = 'block';
        const dangerTips = {
            3: 'Stay left. That sharp drop on the left punishes anything wayward.',
            4: 'Accept bogey here. A 5 is a great score. Do not go for the hero shot.',
            5: 'Lay up short of the danger zone. A comfortable chip beats a risky approach.',
            7: 'Find the fairway first. Long and tight â€” bogey is a win here.',
            8: 'Club up on the approach. That elevated green eats short shots.',
            11: 'Keep it simple: fairway, pitch short, two putts. Do not be greedy.',
            13: 'Two solid shots then wedge. Do not try to reach in two.',
            15: 'SI 2 â€” this is hard. Fairway is everything. Stay conservative.',
            17: 'This is your worst hole. Lay up to 80-100y. Do NOT go for the green in two.',
        };
        document.getElementById('cb-danger-text').textContent = dangerTips[h.num] || 'Play conservatively. Take your medicine.';
    } else {
        dangerBlock.style.display = 'none';
    }

    // Auto-expand briefing on each new hole
    briefingCollapsed = false;
    document.getElementById('caddie-briefing').classList.remove('collapsed');

    // Score buttons
    const minScore = Math.max(1, h.par - 2);
    const maxScore = h.par + 4;
    const container = document.getElementById('score-buttons');
    container.innerHTML = '';
    for (let s = minScore; s <= maxScore; s++) {
        const cls = getScoreClass(h.par, s);
        const lbl = getScoreLabel(h.par, s);
        const wrap = document.createElement('div');
        wrap.className = 'score-btn-wrap';
        wrap.innerHTML = `<button class="score-btn ${cls} ${d.score===s?'selected':''}" onclick="selectScore(${s})">${s}</button><span class="score-label">${lbl}</span>`;
        container.appendChild(wrap);
    }

    document.querySelectorAll('.putt-btn').forEach(btn => btn.classList.toggle('selected', parseInt(btn.dataset.putts)===d.putts));

    const fwGroup = document.getElementById('fairway-group');
    fwGroup.style.opacity = isPar3 ? '0.3' : '1';
    fwGroup.style.pointerEvents = isPar3 ? 'none' : 'auto';
    const fwBtns = fwGroup.querySelectorAll('.toggle-btn');
    const fwMap = {'C':0,'L':1,'R':2,'X':3};
    const fwCls = {'C':'hit','L':'miss-l','R':'miss-r','X':'ob'};
    fwBtns.forEach(b => b.className='toggle-btn');
    if (d.fairway) { const i=fwMap[d.fairway]; fwBtns[i].classList.add(fwCls[d.fairway]); }

    const girBtns = document.querySelectorAll('#screen-play .stats-row > div:last-child .toggle-btn');
    girBtns[0].classList.toggle('hit', d.gir===true);
    girBtns[1].classList.toggle('hit', d.gir===false);

    updatePointsDisplay(idx);

    document.getElementById('btn-prev').style.visibility = idx===0 ? 'hidden' : 'visible';
    document.getElementById('btn-next').textContent = idx===17 ? 'Finish Round â†’' : 'Next Hole â†’';
    document.getElementById('play-scroll').scrollTo(0,0);
}

function updatePointsDisplay(idx) {
    const d = holeData[idx];
    const result = document.getElementById('points-result');
    if (!d.score) { result.classList.remove('visible'); return; }
    const pts = calcPoints(idx, d.score);
    const ps = getPointsStyle(pts);
    result.classList.add('visible');
    result.style.background = ps.bg+'22';
    result.style.border = `1px solid ${ps.bg}55`;
    document.getElementById('pr-val').textContent = pts;
    document.getElementById('pr-val').style.color = ps.bg;
    document.getElementById('pr-name').textContent = getScoreLabel(HOLES[idx].par, d.score);
}

function selectScore(score) {
    holeData[currentHole].score = score;
    const h = HOLES[currentHole];
    const min = Math.max(1, h.par-2);
    document.querySelectorAll('#score-buttons .score-btn').forEach((btn,i) => btn.classList.toggle('selected', (min+i)===score));
    updatePointsDisplay(currentHole);
    document.getElementById('tb-pts').textContent = getTotalPoints();
}

function selectPutts(putts) {
    holeData[currentHole].putts = putts;
    document.querySelectorAll('.putt-btn').forEach(btn => btn.classList.toggle('selected', parseInt(btn.dataset.putts)===putts));
}

function selectFairway(val) {
    if (HOLES[currentHole].par===3) return;
    holeData[currentHole].fairway = val;
    const btns = document.querySelectorAll('#fairway-group .toggle-btn');
    btns.forEach(b => b.className='toggle-btn');
    const map = {'C':[0,'hit'],'L':[1,'miss-l'],'R':[2,'miss-r'],'X':[3,'ob']};
    const [i,cls] = map[val];
    btns[i].classList.add(cls);
}

function selectGIR(val) {
    holeData[currentHole].gir = val;
    const btns = document.querySelectorAll('#screen-play .stats-row > div:last-child .toggle-btn');
    btns[0].classList.toggle('hit', val===true);
    btns[1].classList.toggle('hit', val===false);
}

function prevHole() {
    if (currentHole > 0) renderHole(currentHole - 1, true);
}

function nextHole() {
    const prev = currentHole;
    if (currentHole < 17) {
        const next = currentHole + 1;
        renderHole(next);

        // Show post-hole feedback for the hole we just left
        if (holeData[prev].score) {
            showHoleFeedback(prev);
        }

        // Momentum check (after hole 3+)
        const momentum = getMomentum(next);
        const badge = document.getElementById('momentum-badge');
        if (momentum) {
            badge.className = 'momentum-badge visible ' + momentum.type;
            document.getElementById('momentum-icon').textContent = momentum.icon;
            document.getElementById('momentum-text').textContent = momentum.text;
        }

        // Milestone check (halfway)
        const milestone = checkMilestone(next);
        if (milestone) {
            const mb = document.getElementById('milestone-banner');
            mb.classList.add('visible');
            document.getElementById('milestone-icon').textContent  = milestone.icon;
            document.getElementById('milestone-title').textContent = milestone.title;
            document.getElementById('milestone-sub').textContent   = milestone.sub;
        }

    } else {
        showSummary();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSummary() {
    let totalScore=0, totalPutts=0, totalGIR=0, totalFIR=0, totalPts=0;
    holeData.forEach((d,i) => {
        if (d.score) { totalScore+=d.score; totalPts+=calcPoints(i,d.score); }
        if (d.putts) totalPutts+=d.putts;
        if (d.gir===true) totalGIR++;
        if (d.fairway==='C') totalFIR++;
    });
    document.getElementById('sum-pts').textContent   = totalPts;
    document.getElementById('sum-score').textContent = totalScore||'â€”';
    document.getElementById('sum-putts').textContent = totalPutts||'â€”';
    document.getElementById('sum-girs').textContent  = totalGIR;
    document.getElementById('sum-firs').textContent  = totalFIR;
    document.getElementById('sum-date').textContent  = new Date(roundDate+'T12:00:00').toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    document.getElementById('sum-name').textContent  = playerName+' Â· HC '+playingHC;

    const list = document.getElementById('hole-summary-list');
    list.innerHTML = '';
    holeData.forEach((d,i) => {
        const h = HOLES[i];
        const pts = d.score ? calcPoints(i,d.score) : 0;
        const ps = getPointsStyle(pts);
        const row = document.createElement('div');
        row.className = 'hole-summary-row';
        row.innerHTML = `
            <div class="hs-num">${h.num}</div>
            <div class="hs-par">Par ${h.par}</div>
            <div style="font-size:11px;color:var(--gray);flex:1">${d.putts?d.putts+' putts':''}</div>
            <div class="hs-score">${d.score||'â€”'}</div>
            <div class="hs-pts" style="background:${ps.bg}22;color:${ps.bg};border:1px solid ${ps.bg}44">${pts}</div>`;
        list.appendChild(row);
    });

    document.getElementById('save-status').className = 'save-status';
    document.getElementById('btn-save').disabled = false;
    document.getElementById('btn-save').textContent = 'SAVE ROUND';
    showScreen('screen-summary');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveRound() {
    const btn = document.getElementById('btn-save');
    const statusEl = document.getElementById('save-status');
    btn.disabled = true; btn.textContent = 'SAVING...';
    try {
        let totalScore=0, totalPutts=0, totalGIR=0, totalPts=0;
        holeData.forEach((d,i) => {
            if (d.score) { totalScore+=d.score; totalPts+=calcPoints(i,d.score); }
            if (d.putts) totalPutts+=d.putts;
            if (d.gir===true) totalGIR++;
        });

        let userId;
        const { data: prefs } = await sb.from('user_preferences').select('user_id').limit(1).single();
        if (prefs) {
            userId = prefs.user_id;
        } else {
            const { data: nu } = await sb.from('user_preferences')
                .insert({name:playerName, current_handicap:playingHC, target_handicap:targetHC})
                .select('user_id').single();
            userId = nu?.user_id;
        }
        if (!userId) throw new Error('Could not find user');

        const { data: round, error: rErr } = await sb.from('rounds').insert({
            user_id: userId, course_id: courseId, date: roundDate,
            playing_handicap: playingHC, total_score: totalScore,
            total_putts: totalPutts, gir_count: totalGIR, stableford_points: totalPts,
        }).select().single();
        if (rErr) throw rErr;

        const shots = holeData.map((d,i) => ({
            round_id: round.id, hole_id: holeIds[i]||null,
            hole_number: i+1, score: d.score, putts: d.putts, fairway: d.fairway, gir: d.gir,
        })).filter(s => s.score);
        if (shots.length) await sb.from('shots').insert(shots);

        statusEl.className = 'save-status success';
        statusEl.textContent = 'âœ“ Round saved! Head to Stats to see your breakdown.';
        btn.textContent = 'SAVED âœ“';
        recentRounds = [];
        holeStats = [];
        await loadHomeData();

    } catch(e) {
        statusEl.className = 'save-status error';
        statusEl.textContent = 'âš  Save failed: '+e.message;
        btn.disabled = false; btn.textContent = 'SAVE ROUND';
    }
}

function goHome() { showScreen('screen-home'); }

function newRound() {
    holeData = Array.from({length:18}, () => ({score:null,putts:null,fairway:null,gir:null}));
    showScreen('screen-setup');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    // Update nav active state
    document.querySelectorAll('.bnav-btn').forEach(b => b.classList.remove('active'));
    if (id==='screen-home')  document.querySelectorAll('.bnav-btn:nth-child(1)').forEach(b=>b.classList.add('active'));
    if (id==='screen-stats') { document.querySelectorAll('.bnav-btn:nth-child(2)').forEach(b=>b.classList.add('active')); loadStats(); }
    if (id==='screen-setup') document.querySelectorAll('.bnav-btn:nth-child(3)').forEach(b=>b.classList.add('active'));
}

function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CURRENT HC â€” EDITABLE (MYEG updates)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onCurrentHCChange() {
    document.getElementById('hc-current-save-btn').style.display = 'block';
}

async function saveCurrentHC() {
    const val = parseFloat(document.getElementById('home-hc').value);
    if (isNaN(val) || val < 0 || val > 54) return;
    playingHC = val;
    document.getElementById('hc-current-save-btn').style.display = 'none';
    document.getElementById('setup-hc').value = playingHC;
    try {
        const { data: prefs } = await sb.from('user_preferences').select('user_id').limit(1).single();
        if (prefs) {
            await sb.from('user_preferences').update({ current_handicap: playingHC }).eq('user_id', prefs.user_id);
        }
    } catch(e) { console.warn('Could not save current HC:', e); }
    // Refresh progress bar
    const startHC = 36;
    const progress = Math.min(100, Math.max(0, ((startHC - playingHC) / (startHC - targetHC)) * 100));
    document.getElementById('home-hc-bar').style.width = progress + '%';
    const needed = playingHC - targetHC;
    document.getElementById('home-hc-bar-lbl').textContent = needed > 0 ? `${needed.toFixed(1)} shots to go` : 'ğŸ‰ Target reached!';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TARGET HC â€” EDITABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onTargetHCChange() {
    document.getElementById('hc-save-btn').style.display = 'block';
}

async function saveTargetHC() {
    const val = parseFloat(document.getElementById('home-target-hc').value);
    if (isNaN(val) || val < 0 || val > 54) return;
    targetHC = val;
    document.getElementById('hc-save-btn').style.display = 'none';
    try {
        const { data: prefs } = await sb.from('user_preferences').select('user_id').limit(1).single();
        if (prefs) {
            await sb.from('user_preferences').update({ target_handicap: targetHC }).eq('user_id', prefs.user_id);
        }
    } catch(e) { console.warn('Could not save target HC:', e); }
    // Refresh progress bar
    const startHC = 36;
    const progress = Math.min(100, Math.max(0, ((startHC - playingHC) / (startHC - targetHC)) * 100));
    document.getElementById('home-hc-bar').style.width = progress + '%';
    const needed = playingHC - targetHC;
    document.getElementById('home-hc-bar-lbl').textContent = needed > 0 ? `${needed.toFixed(1)} shots to go` : 'ğŸ‰ Target reached!';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE ROUND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingDeleteId = null;

function confirmDelete(roundId, dateStr) {
    pendingDeleteId = roundId;
    const box = document.createElement('div');
    box.className = 'delete-confirm';
    box.id = 'delete-confirm-overlay';
    box.innerHTML = `
        <div class="delete-confirm-box">
            <div class="delete-confirm-title">Delete Round?</div>
            <div class="delete-confirm-sub">${dateStr} â€” this cannot be undone</div>
            <div class="delete-confirm-btns">
                <button class="delete-cancel" onclick="cancelDelete()">Cancel</button>
                <button class="delete-go" onclick="executeDelete()">Delete</button>
            </div>
        </div>`;
    document.body.appendChild(box);
}

function cancelDelete() {
    pendingDeleteId = null;
    const el = document.getElementById('delete-confirm-overlay');
    if (el) el.remove();
}

async function executeDelete() {
    if (!pendingDeleteId) return;
    const id = pendingDeleteId;
    cancelDelete();
    try {
        await sb.from('shots').delete().eq('round_id', id);
        await sb.from('rounds').delete().eq('id', id);
        recentRounds = recentRounds.filter(r => r.id !== id);
        await loadStats();
        await loadHomeData();
    } catch(e) {
        alert('Could not delete round: ' + e.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROJECTION HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcTargetGrossScore(hc) {
    // Hoebridge: course rating 69, slope 116, par 72
    // Playing HC = (slope/113) * handicap index â‰ˆ handicap index for simplicity
    // Target gross = par + hc adjusted for course
    // Simple: par 72 + (hc - 0) where scratch = 72 (par)
    // More accurate: course handicap = HC * (slope/113), target score = par + course_hc
    const courseHC = Math.round(hc * (116 / 113));
    return 72 + courseHC;
}

function linearRegression(points) {
    // points = [{x: timestamp_ms, y: value}]
    const n = points.length;
    if (n < 2) return null;
    const sumX  = points.reduce((s,p) => s + p.x, 0);
    const sumY  = points.reduce((s,p) => s + p.y, 0);
    const sumXY = points.reduce((s,p) => s + p.x * p.y, 0);
    const sumX2 = points.reduce((s,p) => s + p.x * p.x, 0);
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    return { slope, intercept, predict: x => slope * x + intercept };
}

function projectDate(regression, targetY, direction) {
    // direction: 'down' if improving score (lower), 'up' if improving pts (higher)
    if (!regression) return null;
    if (regression.slope === 0) return null;
    const x = (targetY - regression.intercept) / regression.slope;
    if (x < Date.now()) return null; // already passed
    if (x > Date.now() + 1000 * 60 * 60 * 24 * 365 * 5) return null; // > 5 years, unrealistic
    return new Date(x);
}

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
