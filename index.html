<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Golf Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-dark: #0a1628;
            --bg-card: #1a2538;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --text-white: #f8fafc;
            --text-gray: #94a3b8;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #0f1c2e 100%);
            color: var(--text-white);
            min-height: 100vh;
        }
        
        #root { padding-bottom: 60px; }
        
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #1e3a5f 0%, var(--bg-dark) 100%);
            border-bottom: 3px solid var(--accent-green);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
            padding: 15px;
            text-align: center;
        }
        
        .header h1 { font-size: 22px; color: var(--accent-green); }
        .header .subtitle { font-size: 11px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 1px; }
        
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        
        .course-select {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .course-select label {
            display: block;
            font-size: 10px;
            color: var(--text-gray);
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .input-group { margin-bottom: 10px; }
        
        .score-input, .score-select, .main-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-white);
            font-size: 16px;
        }
        
        .round-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stableford-hero {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .info-item {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-label { font-size: 9px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 4px; }
        .info-value { font-size: 20px; font-weight: 700; color: var(--text-white); }
        
        .hole-card {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .hole-card.danger { border: 2px solid var(--accent-red); }
        
        .hole-header {
            padding: 10px 15px;
            background: #2a3f5f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hole-num { font-size: 20px; font-weight: 800; }
        .par-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            background: #22d3ee;
            color: #000;
            margin-left: 8px;
        }
        
        .points-pill {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 800;
        }
        
        .caddie-tip {
            padding: 10px 15px;
            background: rgba(16, 185, 129, 0.05);
            border-left: 3px solid var(--accent-green);
            font-size: 12px;
            color: #cbd5e1;
            font-style: italic;
        }
        
        .scoring-grid {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .btn-save { background: var(--accent-green); color: #052e16; }
        .btn-save:disabled { background: #334155; color: #94a3b8; }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .status.success { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .status.error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const SUPABASE_URL = 'https://fnnxleatonxijyfghpts.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZubnhsZWF0b254aWp5ZmdocHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDQ2NzMsImV4cCI6MjA4NzYyMDY3M30.83t4SPEJ3okFR9M04O4T96-55ybS0__cI3TKP9v034k';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function App() {
            const [courses, setCourses] = useState([]);
            const [selectedCourse, setSelectedCourse] = useState('');
            const [holes, setHoles] = useState([]);
            const [scores, setScores] = useState({});
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [status, setStatus] = useState(null);
            const [roundDate, setRoundDate] = useState(new Date().toISOString().split('T')[0]);
            const [playingHC, setPlayingHC] = useState(27);

            useEffect(() => { loadCourses(); }, []);
            useEffect(() => { if (selectedCourse) loadHoles(selectedCourse); }, [selectedCourse]);

            async function loadCourses() {
                try {
                    const { data, error } = await supabase.from('courses').select('*').order('name');
                    if (error) throw error;
                    setCourses(data);
                    if (data.length > 0) setSelectedCourse(data[0].id);
                    setLoading(false);
                } catch (e) { setStatus({ type: 'error', message: 'Failed to load courses' }); }
            }

            async function loadHoles(courseId) {
                try {
                    const { data, error } = await supabase.from('holes').select('*').eq('course_id', courseId).order('hole_number');
                    if (error) throw error;
                    setHoles(data);
                    const initial = {};
                    data.forEach(h => initial[h.id] = { score: '', putts: '', fairway: '', gir: false });
                    setScores(initial);
                } catch (e) { setStatus({ type: 'error', message: 'Failed to load holes' }); }
            }

            const getPointColor = (pts) => {
                if (pts >= 4) return { bg: '#10b981', text: '#fff' }; // Eagle+
                if (pts === 3) return { bg: '#3b82f6', text: '#fff' }; // Birdie
                if (pts === 2) return { bg: '#fbbf24', text: '#000' }; // Par
                if (pts === 1) return { bg: '#fb923c', text: '#000' }; // Bogey
                return { bg: '#475569', text: '#fff' }; // Double+
            };

            const calculateHolePoints = (hole, holeScore) => {
                const s = parseInt(holeScore);
                if (!s || isNaN(s)) return 0;
                const shotsReceived = Math.floor(playingHC / 18) + (hole.stroke_index <= (playingHC % 18) ? 1 : 0);
                const netScore = s - shotsReceived;
                const diff = hole.par - netScore;
                return Math.max(0, diff + 2);
            };

            // Totals
            const totals = useMemo(() => {
                let score = 0, pts = 0, putts = 0, girs = 0, holesPlayed = 0;
                holes.forEach(h => {
                    const s = scores[h.id];
                    if (s?.score) {
                        score += parseInt(s.score);
                        pts += calculateHolePoints(h, s.score);
                        putts += parseInt(s.putts) || 0;
                        if (s.gir) girs++;
                        holesPlayed++;
                    }
                });
                return { score, pts, putts, girs, holesPlayed };
            }, [scores, holes, playingHC]);

            const updateScore = (holeId, field, value) => {
                setScores(prev => ({
                    ...prev,
                    [holeId]: { ...prev[holeId], [field]: value }
                }));
            };

            async function saveRound() {
                setSaving(true);
                try {
                    // Get or create user
                    let { data: user, error: userError } = await supabase.from('user_preferences').select('user_id').limit(1).single();
                    
                    // If no user exists, create one
                    if (userError || !user) {
                        const { data: newUser, error: createError } = await supabase
                            .from('user_preferences')
                            .insert({ name: 'Rajiv', current_handicap: 27.0, target_handicap: 16.0 })
                            .select('user_id')
                            .single();
                        
                        if (createError) throw new Error('Could not create user: ' + createError.message);
                        user = newUser;
                    }
                    
                    if (!user) throw new Error('User settings not found');

                    const { data: round, error: rErr } = await supabase.from('rounds').insert({
                        user_id: user.user_id,
                        course_id: selectedCourse,
                        date: roundDate,
                        playing_handicap: playingHC,
                        total_score: totals.score,
                        total_putts: totals.putts,
                        gir_count: totals.girs,
                        stableford_points: totals.pts
                    }).select().single();

                    if (rErr) throw rErr;

                    const shots = holes.filter(h => scores[h.id].score).map(h => ({
                        round_id: round.id,
                        hole_id: h.id,
                        hole_number: h.hole_number,
                        score: parseInt(scores[h.id].score),
                        putts: parseInt(scores[h.id].putts) || 0,
                        fairway: scores[h.id].fairway,
                        gir: scores[h.id].gir
                    }));

                    await supabase.from('shots').insert(shots);
                    setStatus({ type: 'success', message: 'Round Saved Successfully!' });
                    setTimeout(() => setStatus(null), 4000);
                } catch (e) {
                    setStatus({ type: 'error', message: e.message });
                } finally { setSaving(false); }
            }

            if (loading) return <div style={{padding: '50px', textAlign: 'center'}}>Loading Course Data...</div>;

            return (
                <div>
                    <div className="header">
                        <h1>â›³ Golf Tracker Pro</h1>
                        <div className="subtitle">Path to 16 Handicap</div>
                    </div>

                    <div className="container">
                        <div className="course-select">
                            <div className="input-group">
                                <label>Course</label>
                                <select className="score-select" value={selectedCourse} onChange={e => setSelectedCourse(e.target.value)}>
                                    {courses.map(c => <option key={c.id} value={c.id}>{c.name} (Par {c.par})</option>)}
                                </select>
                            </div>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                                <div className="input-group">
                                    <label>Handicap</label>
                                    <input type="number" className="score-input" value={playingHC} onChange={e => setPlayingHC(parseInt(e.target.value))} />
                                </div>
                                <div className="input-group">
                                    <label>Date</label>
                                    <input type="date" className="score-input" value={roundDate} onChange={e => setRoundDate(e.target.value)} />
                                </div>
                            </div>
                        </div>

                        {status && <div className={`status ${status.type}`}>{status.message}</div>}

                        <div className="round-info">
                            <div className="stableford-hero">
                                <div className="info-label" style={{color: '#d1fae5'}}>Stableford Points</div>
                                <div className="info-value" style={{fontSize: '32px'}}>{totals.pts}</div>
                                <div style={{fontSize: '10px', color: '#d1fae5'}}>Target: 36 for Handicap</div>
                            </div>
                            <div className="info-item">
                                <div className="info-label">Gross</div>
                                <div className="info-value">{totals.score}</div>
                            </div>
                            <div className="info-item">
                                <div className="info-label">Putts</div>
                                <div className="info-value">{totals.putts}</div>
                            </div>
                            <div className="info-item">
                                <div className="info-label">GIR</div>
                                <div className="info-value">{totals.girs}</div>
                            </div>
                        </div>

                        {holes.map(h => {
                            const holePts = calculateHolePoints(h, scores[h.id]?.score);
                            const style = getPointColor(holePts);
                            return (
                                <div key={h.id} className={`hole-card ${h.is_danger_hole ? 'danger' : ''}`}>
                                    <div className="hole-header">
                                        <div>
                                            <span className="hole-num">#{h.hole_number}</span>
                                            <span className="par-badge">Par {h.par}</span>
                                        </div>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <span style={{fontSize: '11px', color: '#94a3b8'}}>SI {h.stroke_index}</span>
                                            {scores[h.id]?.score && (
                                                <span className="points-pill" style={{backgroundColor: style.bg, color: style.text}}>
                                                    {holePts} pts
                                                </span>
                                            )}
                                        </div>
                                    </div>

                                    {h.caddie_tip && <div className="caddie-tip">Caddie: {h.caddie_tip}</div>}

                                    <div className="scoring-grid">
                                        <div className="input-group">
                                            <label className="info-label">Score</label>
                                            <input type="number" inputMode="numeric" pattern="[0-9]*" className="score-input" 
                                                value={scores[h.id]?.score} placeholder="-"
                                                onChange={e => updateScore(h.id, 'score', e.target.value)} />
                                        </div>
                                        <div className="input-group">
                                            <label className="info-label">Putts</label>
                                            <input type="number" inputMode="numeric" pattern="[0-9]*" className="score-input" 
                                                value={scores[h.id]?.putts} placeholder="-"
                                                onChange={e => updateScore(h.id, 'putts', e.target.value)} />
                                        </div>
                                        <div className="input-group">
                                            <label className="info-label">Fairway</label>
                                            <select className="score-select" disabled={h.par === 3}
                                                value={scores[h.id]?.fairway} onChange={e => updateScore(h.id, 'fairway', e.target.value)}>
                                                <option value="">-</option>
                                                <option value="C">Fairway</option>
                                                <option value="L">Miss Left</option>
                                                <option value="R">Miss Right</option>
                                                <option value="X">OB/Lost</option>
                                            </select>
                                        </div>
                                        <div className="input-group">
                                            <label className="info-label">GIR</label>
                                            <select className="score-select" value={scores[h.id]?.gir ? 'Y' : 'N'}
                                                onChange={e => updateScore(h.id, 'gir', e.target.value === 'Y')}>
                                                <option value="N">No</option>
                                                <option value="Y">Yes</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}

                        <button className="btn btn-save" onClick={saveRound} disabled={saving || totals.holesPlayed === 0}>
                            {saving ? 'Saving...' : 'Finish & Save Round'}
                        </button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
